/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as n,jsxs as K}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as Ee,classes as ye}from"@dropins/tools/lib.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{g as Ue,c as Le,a as Me}from"./createCustomerAddress.js";import{useState as p,useEffect as Te,useCallback as L,useMemo as xe}from"@dropins/tools/preact-hooks.js";import{s as de,b as Se}from"./simplifyTransformAttributesForm.js";import{v as ve,u as Ce,a as qe}from"./usePasswordValidationMessage.js";import{a as Ae}from"./getCustomerToken.js";import{p as le,E as fe}from"./getStoreConfig.js";import{c as W,g as Be,u as Ke,F as je,B as he}from"./UpdatePasswordForm.js";import{c as Ie}from"./transform-attributes-form.js";import{Header as Ge,InLineAlert as He,InputPassword as ge,Field as se,Checkbox as ie}from"@dropins/tools/components.js";/* empty css                       */import{S as Ve}from"./SkeletonLoader.js";import{E as We}from"./EmailConfirmationForm.js";import{useText as $e}from"@dropins/tools/i18n.js";const pe=(u,r)=>r!=null&&r.length?u.map(e=>{var c;const t=(c=r.find(({code:m})=>m===e.code))==null?void 0:c.defaultValue;return t?{...e,defaultValue:t}:e}):u,Je=({inputsDefaultValueSet:u,fieldsConfigForApiVersion1:r,apiVersion2:e})=>{const[t,c]=p([]);return Te(()=>{(async()=>{if(e){const s=await Ue("customer_account_create");if(s!=null&&s.length)if(u!=null&&u.length){const F=pe(s,u);c(F)}else c(s)}else{const s=de(Se),F=de(r),N=pe(s,u);c(r&&r.length?F:N)}})()},[e,r,u]),{fieldsListConfigs:t}},Oe=(u,r)=>{const e=["date_of_birth","dob","email","firstname","gender","is_subscribed","lastname","middlename","password","prefix","suffix","taxvat"],t=Ie(u,"snakeCase",{firstName:"firstname",lastName:"lastname"});if(!r)return{...t,...t!=null&&t.gender?{gender:Number(t==null?void 0:t.gender)}:{}};const c={},m=[];return Object.keys(t).forEach(s=>{e.includes(s)?c[s]=s.includes("gender")?Number(t[s]):t[s]:m.push({attribute_code:s,value:t[s]})}),m.length>0&&(c.custom_attributes=m),c},Qe=({requireRetypePassword:u,addressesData:r,translations:e,isEmailConfirmationRequired:t,apiVersion2:c=!0,passwordConfigs:m,isAutoSignInEnabled:s,routeRedirectOnSignIn:F,routeSignIn:N,onErrorCallback:M,onSuccessCallback:h,setActiveComponent:b,handleSetInLineAlertProps:w,routeRedirectOnEmailConfirmationClose:S})=>{const[$,v]=p(!1),[o,a]=p(""),[g,d]=p(""),[j,E]=p(""),[I,C]=p(!1),[J,q]=p({userName:"",status:!1}),[l,A]=p(""),[O,G]=p(!1),[Q,y]=p(!1),[H,X]=p(!0),Y=L(i=>{const f=i.target.value;v(!f.length),f.length&&o.length&&f!==o&&d(e.passwordMismatch)},[o,e.passwordMismatch]),Z=L(i=>{const f=i.target.value;d(f.length?"":e.requiredFieldError),f.length&&l.length&&f!==l&&d(e.passwordMismatch)},[l,e.passwordMismatch,e.requiredFieldError]),k=L(i=>{a(i),d(i?l===i?"":e.passwordMismatch:e.requiredFieldError)},[e,l]),z=L(({target:i})=>{X(i.checked)},[]),D=L(()=>{if(W(b)){b("signInForm");return}W(N)&&(window.location.href=N())},[b,N]),R=L(i=>{A(i),v(!i.length),i===o&&d("")},[o]),ee=L(()=>{w(),A(""),W(S)?window.location.href=S():(C(!1),b==null||b("signInForm"))},[w,S,b]),U=()=>{G(!0),y(!1)},P=()=>{const i=l.length&&o.length,f=l!==o;U(),v(!l.length),o||d(e.requiredFieldError),i&&f&&d(e.passwordMismatch)};return{showPasswordErrorMessage:$,confirmPassword:o,confirmPasswordMessage:g,isKeepMeLogged:H,userEmail:j,showEmailConfirmationForm:I,isSuccessful:J,isClickSubmit:O,signUpPasswordValue:l,isLoading:Q,onSubmitSignUp:async(i,f)=>{var ne,me,ue;if(w(),d(""),y(!0),!f){P();return}if(u&&(g.length||l!==o)){U(),d(o.length?e.passwordMismatch:e.requiredFieldError);return}const Fe=c?"createCustomerV2":"createCustomer",{confirmPasswordField:Xe,...ae}=Be(i.target),{email:re,password:B,is_subscribed:be}=ae,we=(m==null?void 0:m.requiredCharacterClasses)||0,Pe=(m==null?void 0:m.minLength)||1;if(!ve(B,we)||Pe>(B==null?void 0:B.length)){U();return}const _e=Oe({...ae,is_subscribed:!!be||!1},c),{data:T,errors:x}=await Le(_e,c),V=((me=(ne=T==null?void 0:T.createCustomer)==null?void 0:ne.customer)==null?void 0:me.firstname)||"";if(x&&(x!=null&&x.length))w==null||w({type:"error",text:x[0].message}),M==null||M(x),le(fe.CREATE_ACCOUNT_EVENT,{updateProfile:!1}),E(re);else{const te={email:"",...T==null?void 0:T[Fe]};if(le(fe.CREATE_ACCOUNT_EVENT,{email:te==null?void 0:te.email,updateProfile:!0}),t||!s){if(h==null||h({userName:V,status:!0}),t){(ue=i.target)==null||ue.reset(),A(""),C(!0),E(re),y(!1);return}if(!s){y(!1),q({userName:V,status:!0});return}}const _=await Ae({email:re,password:B,translations:e,handleSetInLineAlertProps:w,onErrorCallback:M});if(_!=null&&_.userName){if(r!=null&&r.length)for(const ce of r)try{await Me(ce)}catch(Ne){console.error(e.failedCreateCustomerAddress,ce,Ne)}W(F)?window.location.href=F():(h==null||h({userName:_==null?void 0:_.userName,status:!0}),q({userName:_==null?void 0:_.userName,status:!0}))}else h==null||h({userName:V,status:!0}),q({userName:V,status:!0})}y(!1)},signInButton:D,handleSetSignUpPasswordValue:R,onKeepMeLoggedChange:z,handleHideEmailConfirmationForm:ee,handleConfirmPasswordChange:k,onBlurPassword:Y,onBlurConfirmPassword:Z}},dr=({requireRetypePassword:u=!1,addressesData:r,formSize:e="default",inputsDefaultValueSet:t,fieldsConfigForApiVersion1:c,apiVersion2:m=!0,isAutoSignInEnabled:s=!0,displayTermsOfUseCheckbox:F=!1,displayNewsletterCheckbox:N=!1,hideCloseBtnOnEmailConfirmation:M=!1,routeRedirectOnEmailConfirmationClose:h,routeRedirectOnSignIn:b,routeSignIn:w,onErrorCallback:S,onSuccessCallback:$,setActiveComponent:v,slots:o})=>{const a=$e({title:"Auth.SignUpForm.title",buttonPrimary:"Auth.SignUpForm.buttonPrimary",buttonSecondary:"Auth.SignUpForm.buttonSecondary",privacyPolicyDefaultText:"Auth.SignUpForm.privacyPolicyDefaultText",subscribedDefaultText:"Auth.SignUpForm.subscribedDefaultText",keepMeLoggedText:"Auth.SignUpForm.keepMeLoggedText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",failedCreateCustomerAddress:"Auth.SignUpForm.failedCreateCustomerAddress",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel",requiredFieldError:"Auth.FormText.requiredFieldError",confirmPasswordPlaceholder:"Auth.SignUpForm.confirmPassword.placeholder",confirmPasswordFloatingLabel:"Auth.SignUpForm.confirmPassword.floatingLabel",passwordMismatch:"Auth.SignUpForm.confirmPassword.passwordMismatch"}),{passwordConfigs:g,isEmailConfirmationRequired:d}=Ce(),{fieldsListConfigs:j}=Je({fieldsConfigForApiVersion1:c,apiVersion2:m,inputsDefaultValueSet:t}),{inLineAlertProps:E,handleSetInLineAlertProps:I}=Ke(),{showPasswordErrorMessage:C,confirmPassword:J,confirmPasswordMessage:q,isKeepMeLogged:l,userEmail:A,showEmailConfirmationForm:O,isSuccessful:G,isClickSubmit:Q,signUpPasswordValue:y,isLoading:H,onSubmitSignUp:X,signInButton:Y,handleSetSignUpPasswordValue:Z,onKeepMeLoggedChange:k,handleHideEmailConfirmationForm:z,handleConfirmPasswordChange:D,onBlurPassword:R,onBlurConfirmPassword:ee}=Qe({requireRetypePassword:u,addressesData:r,translations:a,isEmailConfirmationRequired:d,apiVersion2:m,passwordConfigs:g,isAutoSignInEnabled:s,routeRedirectOnSignIn:b,routeSignIn:w,onErrorCallback:S,onSuccessCallback:$,setActiveComponent:v,handleSetInLineAlertProps:I,routeRedirectOnEmailConfirmationClose:h}),{isValidUniqueSymbols:U,defaultLengthMessage:P}=qe({password:y,isClickSubmit:Q,passwordConfigs:g}),oe=xe(()=>C?a.requiredFieldError:U==="error"||(P==null?void 0:P.status)==="error"?" ":"",[P==null?void 0:P.status,U,C,a.requiredFieldError]),i=!d&&(r==null?void 0:r.length);return!j.length&&m?n("div",{className:`auth-sign-up-form auth-sign-up-form--${e} skeleton-loader`,"data-testid":"SignUpForm",children:n(Ve,{activeSkeleton:"signUpForm"})}):G.status&&(o!=null&&o.SuccessNotification)?n(Ee,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:o==null?void 0:o.SuccessNotification,context:{isSuccessful:G}}):O?n(We,{formSize:e,userEmail:A,inLineAlertProps:E,hideCloseBtnOnEmailConfirmation:M,handleSetInLineAlertProps:I,onPrimaryButtonClick:z}):K("div",{className:ye(["auth-sign-up-form",`auth-sign-up-form--${e}`]),"data-testid":"SignUpForm",children:[n(Ge,{title:a.title,divider:!1,className:"auth-sign-up-form__title"}),E.text?n(He,{className:"auth-sign-up-form__notification",type:E.type,variant:"secondary",heading:E.text,icon:E.icon}):null,K(je,{onSubmit:X,className:"auth-sign-up-form__form",loading:H,name:"signUp_form",fieldsConfig:j,children:[K(ge,{validateLengthConfig:P,className:"auth-sign-up-form__form__field",autoComplete:"current-password",name:"password",minLength:g==null?void 0:g.minLength,errorMessage:oe,defaultValue:y,uniqueSymbolsStatus:U,requiredCharacterClasses:g==null?void 0:g.requiredCharacterClasses,onValue:Z,placeholder:a.placeholder,floatingLabel:a.floatingLabel,onBlur:R,children:[u?n("div",{className:"auth-sign-up-form__form__confirm-wrapper",children:n(ge,{className:"auth-sign-up-form__form__field auth-sign-up-form__form__field--confirm-password",autoComplete:"confirmPassword",name:"confirmPasswordField",placeholder:a.confirmPasswordPlaceholder,floatingLabel:a.confirmPasswordFloatingLabel,errorMessage:q,defaultValue:J,onValue:D,onBlur:ee})}):null,i?n("div",{className:"auth-sign-up-form__automatic-login","data-testid":"automaticLogin",children:n(se,{children:n(ie,{name:"",placeholder:a.keepMeLoggedText,label:a.keepMeLoggedText,checked:l,onChange:k})})}):null]}),N||F?K("div",{className:"auth-sign-up-form__item auth-sign-up-form__checkbox",children:[N?n(se,{children:n(ie,{"data-testid":"isSubscribed",name:"is_subscribed",placeholder:a.subscribedDefaultText,label:a.subscribedDefaultText})}):null,F?n(se,{children:n(ie,{"data-testid":"privacyPolicy",name:"privacyPolicy",placeholder:a.privacyPolicyDefaultText,label:a.privacyPolicyDefaultText})}):null]}):null,K("div",{className:"auth-sign-up-form-buttons",children:[n(he,{type:"button",variant:"tertiary",style:{padding:0},buttonText:a.buttonSecondary,enableLoader:!1,onClick:Y}),n(he,{type:"submit",buttonText:a.buttonPrimary,variant:"primary",enableLoader:H})]})]}),n("div",{id:"createCustomerV2"})]})};export{dr as S};
