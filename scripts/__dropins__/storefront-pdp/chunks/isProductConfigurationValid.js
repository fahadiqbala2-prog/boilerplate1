/*! Copyright 2025 Adobe
All Rights Reserved. */
import{merge as oe,Initializer as le}from"@dropins/tools/lib.js";import{events as j}from"@dropins/tools/event-bus.js";import{PRODUCT_FRAGMENT as ne}from"../fragments.js";import{FetchGraphQL as ue}from"@dropins/tools/fetch-graphql.js";import{s as ae}from"./getProductConfigurationValues.js";function $e(e){const n=new URLSearchParams(window.location.search);Object.entries(e).forEach(([i,t])=>{t===null?n.delete(i):n.set(i,String(t))});let r=window.location.pathname;r+=`?${n.toString()}`,r+=window.location.hash,window.history.replaceState({},"",r)}function me(){const e=new URLSearchParams(window.location.search),n={};return e.forEach((r,i)=>{n[i]=r}),n}function ce(e){var n,r,i,t,s,l,a,o,m,u,c,f;return{productId:Number(e==null?void 0:e.externalId),name:e==null?void 0:e.name,sku:(e==null?void 0:e.variantSku)||(e==null?void 0:e.sku),topLevelSku:e==null?void 0:e.sku,specialToDate:void 0,specialFromDate:void 0,newToDate:void 0,newFromDate:void 0,createdAt:void 0,updatedAt:void 0,manufacturer:void 0,countryOfManufacture:void 0,categories:void 0,productType:e==null?void 0:e.productType,pricing:{regularPrice:((r=(n=e==null?void 0:e.prices)==null?void 0:n.regular)==null?void 0:r.amount)||0,minimalPrice:(t=(i=e==null?void 0:e.prices)==null?void 0:i.final)==null?void 0:t.minimumAmount,maximalPrice:(l=(s=e==null?void 0:e.prices)==null?void 0:s.final)==null?void 0:l.maximumAmount,specialPrice:(o=(a=e==null?void 0:e.prices)==null?void 0:a.final)==null?void 0:o.amount,tierPricing:void 0,currencyCode:((u=(m=e==null?void 0:e.prices)==null?void 0:m.final)==null?void 0:u.currency)||"USD"},canonicalUrl:e==null?void 0:e.url,mainImageUrl:(f=(c=e==null?void 0:e.images)==null?void 0:c[0])==null?void 0:f.url}}const fe={PRODUCT_CONTEXT:"productContext"},Pe={PRODUCT_PAGE_VIEW:"product-page-view"};function ie(){return window.adobeDataLayer=window.adobeDataLayer||[],window.adobeDataLayer}function de(e,n){const r=ie();r.push({[e]:null}),r.push({[e]:n})}function he(e,n){ie().push(i=>{const t=i.getState?i.getState():{};i.push({event:e,eventInfo:{...t,...n}})})}function De(e){const n=ce(e);de(fe.PRODUCT_CONTEXT,n),he(Pe.PRODUCT_PAGE_VIEW)}var X=(e=>(e.ComplexProduct="complex",e.SimpleProduct="simple",e))(X||{}),re=(e=>(e.ComplexProductView="ComplexProductView",e.SimpleProductView="SimpleProductView",e))(re||{});function B(e,n){var l,a,o,m,u,c,f,d,P,w,h,_,y,b;const r=((m=(o=(a=(l=e==null?void 0:e.options)==null?void 0:l[0])==null?void 0:a.values)==null?void 0:o[0])==null?void 0:m.__typename)==="ProductViewOptionValueProduct",i=Te(e,r,n==null?void 0:n.preselectFirstOption),t=(e==null?void 0:e.__typename)===re.SimpleProductView?X.SimpleProduct:X.ComplexProduct,s=e?{name:e.name,sku:e.sku,isBundle:r,addToCartAllowed:e.addToCartAllowed,inStock:e.inStock,shortDescription:e.shortDescription,metaDescription:e.metaDescription,metaKeyword:e.metaKeyword,metaTitle:e.metaTitle,description:e.description,images:we(e),prices:Ee(e,r,i),attributes:ge(e),options:ye(e,r),optionUIDs:i,url:e.url,urlKey:e.urlKey,externalId:e.externalId,externalParentId:e.externalParentId,variantSku:e.variantSku,productType:t}:null;return console.log(">>>>> productData",s),console.log(">>>>> config",(c=(u=O.getConfig())==null?void 0:u.models)==null?void 0:c.ProductDetails),oe(s,((w=(P=(d=(f=O.getConfig())==null?void 0:f.models)==null?void 0:d.ProductDetails)==null?void 0:P.transformer)==null?void 0:w.call(P,e))??((b=(y=(_=(h=O.getConfig())==null?void 0:h.models)==null?void 0:_.ProductDetails)==null?void 0:y.transform)==null?void 0:b.call(y,e)))}function we(e){var n,r;return(r=(n=e.images)==null?void 0:n.filter(i=>{var t;return!((t=i.roles)!=null&&t.includes("hide_from_pdp"))}))==null?void 0:r.map(i=>(i.url=i.url.replace(/^https?:/,""),i))}function ge(e){var n,r;return(r=(n=e.attributes)==null?void 0:n.filter(({roles:i})=>(i==null?void 0:i.indexOf("visible_in_pdp"))!==-1))==null?void 0:r.map(({label:i,value:t,name:s})=>({id:s,label:i,value:t.toString().split(",").join(", ")}))}function ye(e,n){const{options:r,optionUIDs:i}=e;return r==null?void 0:r.map(({id:t,title:s,required:l,multi:a,values:o})=>{var c;const m=(c=o==null?void 0:o[0])==null?void 0:c.__typename;let u=o==null?void 0:o[0].type;return u?u=u.replace("COLOR_HEX","color").replace("TEXT","text").replace("IMAGE","image"):u="dropdown",{id:t,type:u,typename:m,label:s,required:l,multiple:a,items:n?Ce(o,i):xe(o,i,u)}})}function Ce(e,n){return e==null?void 0:e.filter(({enabled:r})=>typeof r>"u"||r).map(({id:r,title:i,inStock:t,isDefault:s,product:l})=>({id:r,inStock:t,label:i,selected:(n==null?void 0:n.indexOf(r))>-1||s,value:r,product:l}))}function xe(e,n,r){return e==null?void 0:e.map(({id:i,title:t,inStock:s,value:l})=>({id:i,inStock:s,label:t,selected:(n==null?void 0:n.indexOf(i))>-1,value:(r==null?void 0:r.toLowerCase())==="dropdown"?i:l==null?void 0:l.replace(/^https?:/,"")}))}function Ee(e,n,r){var h,_,y,b,z;const{price:i,priceRange:t,options:s,optionUIDs:l=r}=e;let{__typename:a}=e;function o(){var E;const C=i.regular.amount.value,D=((E=i.final)==null?void 0:E.amount.value)??i.regular.amount.value,x=i.regular.amount.currency==="NONE"?"USD":i==null?void 0:i.regular.amount.currency;return[C,D,D,x]}function m(){var S,p,U,v,A,I,F,V,G,N,M,$;const C=(S=t==null?void 0:t.minimum)==null?void 0:S.final.amount.value,D=(p=t==null?void 0:t.maximum)==null?void 0:p.final.amount.value;let x;((v=(U=t==null?void 0:t.minimum)==null?void 0:U.regular)==null?void 0:v.amount.value)===((I=(A=t==null?void 0:t.maximum)==null?void 0:A.regular)==null?void 0:I.amount.value)&&(x=(V=(F=t==null?void 0:t.minimum)==null?void 0:F.regular)==null?void 0:V.amount.value);const E=((N=(G=t==null?void 0:t.minimum)==null?void 0:G.final)==null?void 0:N.amount.currency)==="NONE"?"USD":($=(M=t==null?void 0:t.minimum)==null?void 0:M.final)==null?void 0:$.amount.currency;return[x,C,D,E]}function u(){var U,v,A,I,F,V,G,N,M,$,W,Y;let C=0,D=0;s==null||s.forEach(k=>{var J;const K=k==null?void 0:k.values;if(K&&Array.isArray(K)){const T=K.map(g=>{var L,Q,Z,R;return(R=(Z=(Q=(L=g==null?void 0:g.product)==null?void 0:L.price)==null?void 0:Q.regular)==null?void 0:Z.amount)==null?void 0:R.value}).filter(g=>g!==void 0),H=T.length>0?Math.max(...T):0;C+=H}(J=k==null?void 0:k.values)==null||J.forEach(T=>{var H,g,L,Q;l!=null&&l.includes(T.id)&&(D+=(Q=(L=(g=(H=T==null?void 0:T.product)==null?void 0:H.price)==null?void 0:g.final)==null?void 0:L.amount)==null?void 0:Q.value)})});const x=(U=t==null?void 0:t.minimum)==null?void 0:U.final.amount.value,E=(v=t==null?void 0:t.maximum)==null?void 0:v.final.amount.value;let S;((I=(A=t==null?void 0:t.minimum)==null?void 0:A.regular)==null?void 0:I.amount.value)===((V=(F=t==null?void 0:t.maximum)==null?void 0:F.regular)==null?void 0:V.amount.value)&&(S=(N=(G=t==null?void 0:t.minimum)==null?void 0:G.regular)==null?void 0:N.amount.value);const p=(($=(M=t==null?void 0:t.minimum)==null?void 0:M.final)==null?void 0:$.amount.currency)==="NONE"?"USD":(Y=(W=t==null?void 0:t.minimum)==null?void 0:W.final)==null?void 0:Y.amount.currency;return n&&(l==null?void 0:l.length)<1?[S,x,E,p]:C===(t==null?void 0:t.maximum.regular.amount.value)?[D,D,D,p]:[S,x,E,p]}const[c,f,d,P]=a==="SimpleProductView"?o():n?u():m(),w=a==="SimpleProductView"?(h=i==null?void 0:i.roles)==null?void 0:h.includes("visible"):((y=(_=t==null?void 0:t.maximum)==null?void 0:_.roles)==null?void 0:y.includes("visible"))&&((z=(b=t==null?void 0:t.minimum)==null?void 0:b.roles)==null?void 0:z.includes("visible"));return d&&f===d?{regular:{amount:c,currency:P,variant:c&&f!==c?"strikethrough":"default"},final:{amount:d,currency:P,variant:"default"},visible:w}:{final:{minimumAmount:f,maximumAmount:d,currency:P},visible:w}}function Te(e,n,r){var i;return n?((i=e==null?void 0:e.options)==null?void 0:i.map(({values:s})=>{var o;const l=((o=s==null?void 0:s.find(({isDefault:m})=>m))==null?void 0:o.id)??null,a=r?s[0].id:null;return l||a})).filter(s=>s!==null):e==null?void 0:e.optionUIDs}const q=new le({init:async e=>{var s,l,a;const n=(l=(s=e==null?void 0:e.models)==null?void 0:s.ProductDetails)==null?void 0:l.initialData,t={...{defaultLocale:"en-US",persistURLParams:!1,acdl:!1,optionsUIDs:((a=me().optionsUIDs)==null?void 0:a.split(","))||(n==null?void 0:n.optionsUIDs)},...e};if(q.config.setConfig({...t}),t!=null&&t.sku){const o=n?B(n):await te(t.sku,{preselectFirstOption:t.preselectFirstOption});j.emit("pdp/data",o);const m={sku:t.sku,quantity:1,optionsUIDs:o==null?void 0:o.optionUIDs};ae(()=>({...m})),Ae(()=>{var u;return o!=null&&o.options?o.options.length===((u=o==null?void 0:o.optionUIDs)==null?void 0:u.length):!0}),t.acdl&&o&&De(o)}},listeners:()=>[j.on("locale",async()=>{const{sku:e}=q.config.getConfig();if(e){const n=await te(e);j.emit("pdp/data",n)}})]}),O=q.config,{setEndpoint:Le,setFetchGraphQlHeader:Qe,removeFetchGraphQlHeader:je,setFetchGraphQlHeaders:He,fetchGraphQl:se,getConfig:Ke}=new ue().getMethods(),Oe=`
query GET_PRODUCT_DATA($skus: [String]) {
    products(skus: $skus) {
        ...PRODUCT_FRAGMENT
    }
}

${ne}
`,Se=async(e,n,r)=>{var s;const{data:i}=await se(Oe,{method:"GET",variables:{skus:[e]}}),t=(s=i==null?void 0:i.products)==null?void 0:s[0];return n!=null&&n.optionsUIDs&&(t.optionUIDs=n.optionsUIDs),t?r?t:B(t,{preselectFirstOption:n==null?void 0:n.preselectFirstOption}):null},pe=`
query REFINE_PRODUCT_QUERY(
    $optionIds: [String!]!
    $sku: String!
) {
    # Refined Product
    refineProduct(
        optionIds: $optionIds 
        sku: $sku
    ) {
        ...PRODUCT_FRAGMENT
    }

    # Parent Product
    products(skus: [$sku]) {
        ...PRODUCT_FRAGMENT
    }

    # %extendedPlaceholder%
}

${ne}
`;async function ee(e,n){const r=_e(n),i=be(r,e),t=pe.replace("# %extendedPlaceholder%",i),{data:s}=await se(t,{method:"GET",variables:{optionIds:n,sku:e}});return s}const ke=async(e,n,r,i)=>{var d,P,w;const t=await ee(e,n);if(!t)return null;let{products:s,refineProduct:l,...a}=t;const o=s==null?void 0:s[0],m=Ue(Object.values(a),o.options,r);if(r!=null&&r.length&&l===null){n=ve(m,n,r);const h=await ee(e,n);l=h==null?void 0:h.refineProduct}const u={...l||o,sku:o.sku,name:o.name,externalParentId:o==null?void 0:o.externalId,options:m,optionUIDs:n,variantSku:(l==null?void 0:l.__typename)==="SimpleProductView"?l==null?void 0:l.sku:void 0},c=i?u:B(u),f=(w=(P=(d=O==null?void 0:O.getConfig())==null?void 0:d.models)==null?void 0:P.ProductDetails)==null?void 0:w.fallbackData;return f?f(o,c):c};function _e(e){if(e.length<2)return[e];const n=[];return e.forEach(r=>{const i=[];e.forEach(t=>{r!==t&&i.push(t)}),n.push(i)}),n}function be(e,n){return e.map((r,i)=>`
          ProductOption${i}: refineProduct(
            optionIds: [
              ${r.map(t=>`"${t}"`).join(", ")}
            ]
            sku: "${n}"
          ) {
            ... on ComplexProductView {
              options {
                ...PRODUCT_OPTION_FRAGMENT
              }
            }
          }
        `).join("")}function Ue(e,n=[],r){const i=Object.values(e).filter(s=>!!s).reduce((s,l)=>l.options?[...s,...l.options]:[...s],[]),t=new Map(n.map(s=>[s.id,s]));return i.forEach(s=>{r!=null&&r.includes(s.id)||t.set(s.id,s)}),[...t.values()]}function ve(e,n,r){const i=[];let t;return e.forEach(s=>{var l,a,o,m;r.includes(s.id)?t=((a=(l=s.values)==null?void 0:l.find(u=>n.includes(u==null?void 0:u.id)))==null?void 0:a.id)||((o=s.values[0])==null?void 0:o.id):t=(m=s.values[0])==null?void 0:m.id,i.push(t)}),i}const te=async(e,n)=>{const{anchors:r,optionsUIDs:i}=O.getConfig(),{optionsUIDs:t=i,anchors:s=r,preselectFirstOption:l,isBundle:a,skipTransform:o}=n??{};return!a&&t?await ke(e,t,s,o):await Se(e,{preselectFirstOption:l,optionsUIDs:t},o)},Ae=e=>{const n=Ie(),r=e(n);n!==r&&j.emit("pdp/valid",r)},Ie=()=>{var e;return((e=j._lastEvent["pdp/valid"])==null?void 0:e.payload)??null};export{Qe as a,He as b,O as c,Se as d,ke as e,se as f,Ke as g,te as h,q as i,Ae as j,Ie as k,$e as l,De as p,je as r,Le as s,B as t};
