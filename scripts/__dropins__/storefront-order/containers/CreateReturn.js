/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as a,jsxs as F}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as H,classes as Q}from"@dropins/tools/lib.js";import{Button as M,CartItem as V,Image as W,Header as $,InLineAlert as Z}from"@dropins/tools/components.js";import{S as D,u as z,a as U,R as K}from"../chunks/OrderCancel.js";import{useState as O,useRef as G,useEffect as T,useCallback as A}from"@dropins/tools/preact-hooks.js";import{events as J}from"@dropins/tools/event-bus.js";import{g as X}from"../chunks/getFormValues.js";import{s as Y}from"../chunks/setTaxStatus.js";import{createRef as I,Fragment as ee}from"@dropins/tools/preact.js";import{o as te,c as ne,n as se,r as ae,m as re}from"../chunks/returnOrdersHelper.js";import{g as ie,r as ce}from"../chunks/requestReturn.js";import{g as ue}from"../chunks/getStoreConfig.js";import*as g from"@dropins/tools/preact-compat.js";import{O as oe}from"../chunks/OrderLoaders.js";import{useText as le}from"@dropins/tools/i18n.js";import"../chunks/form.types.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const de=s=>g.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},g.createElement("g",{clipPath:"url(#clip0_841_1324)"},g.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),g.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),g.createElement("defs",null,g.createElement("clipPath",{id:"clip0_841_1324"},g.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),pe=s=>g.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},g.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),g.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),he=({onSuccess:s,onError:r,handleSetInLineAlert:i,orderData:l})=>{const[o,h]=O(l),[S,k]=O("products"),[w,R]=O(!0),[f,y]=O([]),[v,x]=O([]),[t,C]=O({taxIncluded:!1,taxExcluded:!1}),[e,d]=O([]),m=G([]);m.current.length!==f.length&&(m.current=f.map((n,c)=>m.current[c]||I())),T(()=>{const n=J.on("order/data",c=>{h(c),d(te(c)),R(!1)},{eager:!0});return()=>{n==null||n.off()}},[]),T(()=>{ue().then(n=>{if(n){const c=Y(n==null?void 0:n.shoppingCartDisplayPrice);C(c)}})},[]),T(()=>{ie("RMA_ITEM").then(n=>{n.length&&(x(n),R(!1))})},[]);const _=A(n=>{y(c=>c.findIndex(u=>(u==null?void 0:u.productSku)===(n==null?void 0:n.productSku))>-1?c.filter(u=>(u==null?void 0:u.productSku)!==(n==null?void 0:n.productSku)):[...c,n])},[]),b=A(n=>{k(n),i(),n==="products"&&y([])},[i]),N=A((n,c)=>{const L=f.map(u=>u.productSku===c?{...u,currentReturnOrderQuantity:n}:u);y(L)},[f]),E=A(async(n,c)=>{if(!c)return null;R(!0);const L={orderUid:(o==null?void 0:o.id)??"",contactEmail:(o==null?void 0:o.email)??""},u=[];m.current.length&&m.current.forEach(({current:p})=>{var P;const j=p==null?void 0:p.name.replace(/_\d+$/,""),q=((P=p==null?void 0:p.dataset)==null?void 0:P.quantity)??1,B=ne(X(p));u.push({orderItemUid:j,quantityToReturn:+q,...se(B)})}),ce({...L,items:u}).then(p=>{p&&(s==null||s(p),b("success"),i())}).catch(p=>{r==null||r(p.message),i({type:"error",heading:p.message})}),R(!1)},[b,r,s,i,o]);return{order:o,steps:S,loading:w,formsRef:m,taxConfig:t,attributesList:v,selectedProductList:f,itemsEligibleForReturn:e,handleSelectedProductList:_,handleSetQuantity:N,handleChangeStep:b,onSubmit:E}},me={success:a(pe,{}),warning:a(de,{}),error:a(D,{})},ge=()=>{const[s,r]=O({type:"success",heading:""}),i=A(l=>{if(!(l!=null&&l.type)){r({type:"success",heading:""});return}const o=me[l.type];r({...l,icon:o})},[]);return{inLineAlertProps:s,handleSetInLineAlert:i}},fe=({routeReturnSuccess:s,translations:r,orderData:i})=>{const l=()=>{window.location.href=(s==null?void 0:s(i))??"#"};return F("div",{className:"order-return-order-message",children:[a("p",{className:"order-return-order-message__title",children:r.successTitle}),a("p",{className:"order-return-order-message__subtitle",children:r.successMessage}),a(M,{onClick:l,type:"button",children:r.backStore})]})},be=({slots:s,formsRef:r,selectedProductList:i,loading:l,fieldsConfig:o,translations:h,handleChangeStep:S,onSubmit:k})=>{const{formData:w,errors:R,formRef:f,handleChange:y,handleBlur:v,handleSubmit:x}=z({fieldsConfig:ae(o,i==null?void 0:i.length),onSubmit:k});return F("form",{className:"order-return-reason-form",ref:f,onSubmit:x,name:"returnReasonForm",children:[i.map((t,C)=>{var E,n,c,L,u;const e=(t==null?void 0:t.giftCard)||{},d=t==null?void 0:t.product,m=re(o,C),_=`${t==null?void 0:t.id}_${C}`,b=(t==null?void 0:t.currentReturnOrderQuantity)??1,N={...t!=null&&t.currentReturnOrderQuantity?{Quantity:b}:{},..."configurableOptions"in t?t.configurableOptions:{},..."bundleOptions"in t?t.bundleOptions:{},..."senderName"in e&&(e!=null&&e.senderName)?{[h.sender]:e==null?void 0:e.senderName}:{},..."senderEmail"in e&&(e!=null&&e.senderEmail)?{[h.sender]:e==null?void 0:e.senderEmail}:{},..."recipientName"in e&&(e!=null&&e.recipientName)?{[h.recipient]:e==null?void 0:e.recipientName}:{},..."recipientEmail"in e&&(e!=null&&e.recipientEmail)?{[h.recipient]:e==null?void 0:e.recipientEmail}:{},..."message"in e&&(e!=null&&e.message)?{[h.message]:e==null?void 0:e.message}:{},..."downloadableLinks"in t&&(t!=null&&t.downloadableLinks)?{[`${(E=t==null?void 0:t.downloadableLinks)==null?void 0:E.count} ${h.downloadableCount}`]:(n=t==null?void 0:t.downloadableLinks)==null?void 0:n.result}:{}};return F(ee,{children:[a(V,{loading:l,title:a("div",{"data-testid":"product-name",children:(c=t==null?void 0:t.product)==null?void 0:c.name}),sku:a("div",{children:d==null?void 0:d.sku}),image:a(W,{src:((L=d==null?void 0:d.thumbnail)==null?void 0:L.url)??"",alt:((u=d==null?void 0:d.thumbnail)==null?void 0:u.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:N}),a("form",{name:_,ref:r==null?void 0:r.current[C],"data-quantity":b,children:a(U,{className:"className",loading:l,fields:m,onChange:y,onBlur:v,errors:R,values:w})})]},C)}),s!=null&&s.ReturnFormActions?a(H,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:s==null?void 0:s.ReturnFormActions,context:{handleChangeStep:S}}):F("div",{className:"order-return-reason-form__actions",children:[a(M,{variant:"secondary",type:"button",onClick:()=>{S("products")},children:h.backStep}),a(M,{children:h.submit})]})]})},Be=({className:s,orderData:r,slots:i,onSuccess:l,onError:o,routeReturnSuccess:h,showConfigurableOptions:S})=>{const k=le({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems"}),{inLineAlertProps:w,handleSetInLineAlert:R}=ge(),{order:f,itemsEligibleForReturn:y,formsRef:v,taxConfig:x,attributesList:t,steps:C,loading:e,selectedProductList:d,handleSelectedProductList:m,handleSetQuantity:_,handleChangeStep:b,onSubmit:N}=he({orderData:r,onSuccess:l,onError:o,handleSetInLineAlert:R});if(e)return a("div",{children:a(oe,{})});if(!e&&!t.length)return a("div",{});const E={products:a(K,{itemsEligibleForReturn:y,slots:i,translations:k,loading:e,taxConfig:x,selectedProductList:d,handleSelectedProductList:m,showConfigurableOptions:S,handleSetQuantity:_,handleChangeStep:b}),attributes:a(be,{slots:i,formsRef:v,loading:e,fieldsConfig:t,selectedProductList:d,handleChangeStep:b,translations:k,onSubmit:N}),success:a(fe,{translations:k,routeReturnSuccess:h,orderData:f}),error:null};return F("div",{className:Q(["order-create-return",s]),children:[a($,{title:k.headerText}),w.heading?a(Z,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",...w}):null,E[C]]})};export{Be as CreateReturn,Be as default};
