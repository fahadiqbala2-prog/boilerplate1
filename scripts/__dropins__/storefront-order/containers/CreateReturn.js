import{jsx as r,jsxs as x}from"@dropins/tools/preact-jsx-runtime.js";import{classes as q,Slot as P}from"@dropins/tools/lib.js";import{Checkbox as H,Button as Q,CartItem as V,Image as W,Header as Z,InLineAlert as D}from"@dropins/tools/components.js";import{u as z,a as U}from"../chunks/OrderCancel.js";import{useState as _,useRef as K,useEffect as T,useCallback as F}from"@dropins/tools/preact-hooks.js";import{events as G}from"@dropins/tools/event-bus.js";import{g as J}from"../chunks/getFormValues.js";import{s as X}from"../chunks/setTaxStatus.js";import{createRef as Y,Fragment as I}from"@dropins/tools/preact.js";import{o as ee,c as te,n as ne,r as re,m as ae}from"../chunks/returnOrdersHelper.js";import{g as se,r as ie}from"../chunks/requestReturn.js";import{g as ce}from"../chunks/getStoreConfig.js";import*as R from"@dropins/tools/preact-compat.js";import{S as ue,C as oe}from"../chunks/CartSummaryItem.js";import{O as le}from"../chunks/OrderLoaders.js";import{useText as de}from"@dropins/tools/i18n.js";import"../chunks/form.types.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const pe=a=>R.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...a},R.createElement("g",{clipPath:"url(#clip0_841_1324)"},R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),R.createElement("defs",null,R.createElement("clipPath",{id:"clip0_841_1324"},R.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),he=a=>R.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...a},R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),me=({onSuccess:a,onError:s,handleSetInLineAlert:c,orderData:d})=>{const[u,p]=_(d),[S,b]=_("products"),[L,k]=_(!0),[i,f]=_([]),[C,w]=_([]),[t,h]=_({taxIncluded:!1,taxExcluded:!1}),[e,m]=_([]),y=K([]);y.current.length!==i.length&&(y.current=i.map((n,o)=>y.current[o]||Y())),T(()=>{const n=G.on("order/data",o=>{p(o),m(ee(o)),k(!1)},{eager:!0});return()=>{n==null||n.off()}},[]),T(()=>{ce().then(n=>{if(n){const o=X(n==null?void 0:n.shoppingCartDisplayPrice);h(o)}})},[]),T(()=>{se("RMA_ITEM").then(n=>{n.length&&(w(n),k(!1))})},[]);const N=F(n=>{f(o=>o.findIndex(l=>(l==null?void 0:l.productSku)===(n==null?void 0:n.productSku))>-1?o.filter(l=>(l==null?void 0:l.productSku)!==(n==null?void 0:n.productSku)):[...o,n])},[]),O=F(n=>{b(n),c(),n==="products"&&f([])},[c]),A=F((n,o)=>{const v=i.map(l=>l.productSku===o?{...l,currentReturnOrderQuantity:n}:l);f(v)},[i]),E=F(async(n,o)=>{if(!o)return null;k(!0);const v={orderUid:(u==null?void 0:u.id)??"",contactEmail:(u==null?void 0:u.email)??""},l=[];y.current.length&&y.current.forEach(({current:g})=>{var M;const $=g==null?void 0:g.name.replace(/_\d+$/,""),j=((M=g==null?void 0:g.dataset)==null?void 0:M.quantity)??1,B=te(J(g));l.push({orderItemUid:$,quantityToReturn:+j,...ne(B)})}),ie({...v,items:l}).then(g=>{g&&(a==null||a(g),O("success"),c())}).catch(g=>{s==null||s(g.message),c({type:"error",heading:g.message})}),k(!1)},[O,s,a,c,u]);return{order:u,steps:S,loading:L,formsRef:y,taxConfig:t,attributesList:C,selectedProductList:i,itemsEligibleForReturn:e,handleSelectedProductList:N,handleSetQuantity:A,handleChangeStep:O,onSubmit:E}},ge={success:r(he,{}),warning:r(pe,{}),error:r(ue,{})},fe=()=>{const[a,s]=_({type:"success",heading:""}),c=F(d=>{if(!(d!=null&&d.type)){s({type:"success",heading:""});return}const u=ge[d.type];s({...d,icon:u})},[]);return{inLineAlertProps:a,handleSetInLineAlert:c}},be=({itemsEligibleForReturn:a,slots:s,loading:c=!1,taxConfig:d,translations:u={},selectedProductList:p,handleSelectedProductList:S,showConfigurableOptions:b,handleSetQuantity:L,handleChangeStep:k})=>x("ul",{className:"order-return-order-product-list",children:[a==null?void 0:a.map((i,f)=>{const C=Math.random().toString(36),w=p.some(h=>(h==null?void 0:h.productSku)===i.productSku&&i.eligibleForReturn&&i.quantityReturned===0),t=i.returnableQuantity===0?1:i.returnableQuantity;return x("li",{className:q(["order-return-order-product-list__item",["order-return-order-product-list__item--blur",!i.eligibleForReturn]]),children:[r(H,{"data-testid":`${C}_${f+1}`,name:C+f,checked:w,disabled:!i.eligibleForReturn||i.quantityReturned!==0,onChange:()=>{S({...i,currentReturnOrderQuantity:1})}}),r(oe,{loading:c,product:{...i,totalQuantity:t},itemType:"",taxConfig:d,translations:u,showConfigurableOptions:b,disabledIncrementer:!w,isReturnProductList:!0,onQuantity:(i==null?void 0:i.returnableQuantity)>1?h=>L(h,i.productSku):void 0}),s!=null&&s.ReturnOrderItem?r(P,{"data-testid":"returnOrderItem",name:"ReturnOrderItem",slot:s==null?void 0:s.ReturnOrderItem,context:{}}):null]},C+f)}),r("li",{className:"order-return-order-product-list__item",children:r(Q,{type:"button",onClick:()=>k("attributes"),disabled:!p.length,children:u.nextStep})})]}),ke=({routeReturnSuccess:a,translations:s,orderData:c})=>{const d=()=>{window.location.href=(a==null?void 0:a(c))??"#"};return x("div",{className:"order-return-order-message",children:[r("p",{className:"order-return-order-message__title",children:s.successTitle}),r("p",{className:"order-return-order-message__subtitle",children:s.successMessage}),r(Q,{onClick:d,type:"button",children:s.backStore})]})},ye=({slots:a,formsRef:s,selectedProductList:c,loading:d,fieldsConfig:u,translations:p,handleChangeStep:S,onSubmit:b})=>{const{formData:L,errors:k,formRef:i,handleChange:f,handleBlur:C,handleSubmit:w}=z({fieldsConfig:re(u,c==null?void 0:c.length),onSubmit:b});return x("form",{className:"order-return-reason-form",ref:i,onSubmit:w,name:"returnReasonForm",children:[c.map((t,h)=>{var E,n,o,v,l;const e=(t==null?void 0:t.giftCard)||{},m=t==null?void 0:t.product,y=ae(u,h),N=`${t==null?void 0:t.id}_${h}`,O=(t==null?void 0:t.currentReturnOrderQuantity)??1,A={...t!=null&&t.currentReturnOrderQuantity?{Quantity:O}:{},..."configurableOptions"in t?t.configurableOptions:{},..."bundleOptions"in t?t.bundleOptions:{},..."senderName"in e&&(e!=null&&e.senderName)?{[p.sender]:e==null?void 0:e.senderName}:{},..."senderEmail"in e&&(e!=null&&e.senderEmail)?{[p.sender]:e==null?void 0:e.senderEmail}:{},..."recipientName"in e&&(e!=null&&e.recipientName)?{[p.recipient]:e==null?void 0:e.recipientName}:{},..."recipientEmail"in e&&(e!=null&&e.recipientEmail)?{[p.recipient]:e==null?void 0:e.recipientEmail}:{},..."message"in e&&(e!=null&&e.message)?{[p.message]:e==null?void 0:e.message}:{},..."downloadableLinks"in t&&(t!=null&&t.downloadableLinks)?{[`${(E=t==null?void 0:t.downloadableLinks)==null?void 0:E.count} ${p.downloadableCount}`]:(n=t==null?void 0:t.downloadableLinks)==null?void 0:n.result}:{}};return x(I,{children:[r(V,{loading:d,title:r("div",{"data-testid":"product-name",children:(o=t==null?void 0:t.product)==null?void 0:o.name}),sku:r("div",{children:m==null?void 0:m.sku}),image:r(W,{src:((v=m==null?void 0:m.thumbnail)==null?void 0:v.url)??"",alt:((l=m==null?void 0:m.thumbnail)==null?void 0:l.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:A}),r("form",{name:N,ref:s==null?void 0:s.current[h],"data-quantity":O,children:r(U,{className:"className",loading:d,fields:y,onChange:f,onBlur:C,errors:k,values:L})})]},h)}),a!=null&&a.ReturnFormActions?r(P,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:a==null?void 0:a.ReturnFormActions,context:{handleChangeStep:S}}):x("div",{className:"order-return-reason-form__actions",children:[r(Q,{variant:"secondary",type:"button",onClick:()=>{S("products")},children:p.backStep}),r(Q,{children:p.submit})]})]})},He=({className:a,orderData:s,slots:c,onSuccess:d,onError:u,routeReturnSuccess:p,showConfigurableOptions:S})=>{const b=de({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems"}),{inLineAlertProps:L,handleSetInLineAlert:k}=fe(),{order:i,itemsEligibleForReturn:f,formsRef:C,taxConfig:w,attributesList:t,steps:h,loading:e,selectedProductList:m,handleSelectedProductList:y,handleSetQuantity:N,handleChangeStep:O,onSubmit:A}=me({orderData:s,onSuccess:d,onError:u,handleSetInLineAlert:k});if(e)return r("div",{children:r(le,{})});if(!e&&!t.length)return r("div",{});const E={products:r(be,{itemsEligibleForReturn:f,slots:c,translations:b,loading:e,taxConfig:w,selectedProductList:m,handleSelectedProductList:y,showConfigurableOptions:S,handleSetQuantity:N,handleChangeStep:O}),attributes:r(ye,{slots:c,formsRef:C,loading:e,fieldsConfig:t,selectedProductList:m,handleChangeStep:O,translations:b,onSubmit:A}),success:r(ke,{translations:b,routeReturnSuccess:p,orderData:i}),error:null};return x("div",{className:q(["order-create-return",a]),children:[r(Z,{title:b.headerText}),L.heading?r(D,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",...L}):null,E[h]]})};export{He as CreateReturn,He as default};
