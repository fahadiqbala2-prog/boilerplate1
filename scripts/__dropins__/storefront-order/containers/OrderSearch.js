import{jsxs as x,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{classes as V}from"@dropins/tools/lib.js";import{Card as k,InLineAlert as L,Icon as H,Button as P}from"@dropins/tools/components.js";import{F as X}from"../chunks/CustomerDetailsContent.js";import{useState as R,useCallback as D,useEffect as I,useMemo as B}from"@dropins/tools/preact-hooks.js";import*as M from"@dropins/tools/preact-compat.js";import{Text as O,useText as j}from"@dropins/tools/i18n.js";import{events as _}from"@dropins/tools/event-bus.js";import{c as v,g as q}from"../chunks/getCustomer.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";const G=e=>M.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},M.createElement("path",{vectorEffect:"non-scaling-stroke",fillRule:"evenodd",clipRule:"evenodd",d:"M1 20.8953L12.1922 1.5L23.395 20.8953H1ZM13.0278 13.9638L13.25 10.0377V9H11.25V10.0377L11.4722 13.9638H13.0278ZM11.2994 16V17.7509H13.2253V16H11.2994Z",fill:"currentColor"})),W=({onSubmit:e,loading:a,inLineAlert:o,fieldsConfig:r,key:c})=>x(k,{variant:"secondary",className:"dropin-order-search-form",children:[s("h2",{className:"dropin-order-search-form__title",children:s(O,{id:"Order.OrderSearchForm.title"})}),s("p",{children:s(O,{id:"Order.OrderSearchForm.description"})}),o.text?s(L,{"data-testid":"orderAlert",className:"dropin-order-search-form__alert",type:o.type,variant:"secondary",heading:o.text,icon:s(H,{source:G})}):null,s(X,{className:"dropin-order-search-form__wrapper",name:"orderSearchForm",loading:a,fieldsConfig:r,onSubmit:e,children:s("div",{className:"dropin-order-search-form__button-container",children:s(P,{className:"dropin-order-search-form__button",size:"medium",variant:"primary",type:"submit",disabled:a,children:s(O,{id:"Order.OrderSearchForm.button"})},"logIn")})})]},c);var E=(e=>(e.BOOLEAN="BOOLEAN",e.DATE="DATE",e.DATETIME="DATETIME",e.DROPDOWN="DROPDOWN",e.FILE="FILE",e.GALLERY="GALLERY",e.HIDDEN="HIDDEN",e.IMAGE="IMAGE",e.MEDIA_IMAGE="MEDIA_IMAGE",e.MULTILINE="MULTILINE",e.MULTISELECT="MULTISELECT",e.PRICE="PRICE",e.SELECT="SELECT",e.TEXT="TEXT",e.TEXTAREA="TEXTAREA",e.UNDEFINED="UNDEFINED",e.VISUAL="VISUAL",e.WEIGHT="WEIGHT",e.EMPTY="",e))(E||{});const z=e=>{if(!e)return null;const a=new FormData(e);if(e.querySelectorAll('input[type="checkbox"]').forEach(r=>{a.has(r.name)||a.set(r.name,"false"),r.checked&&a.set(r.name,"true")}),a&&typeof a.entries=="function"){const r=a.entries();if(r&&typeof r[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(r)))||{}}return{}},m=(e,a)=>{if(typeof e!="function")return;const o=e();if(!a||Object.keys(a).length===0){window.location.href=o;return}const r=new URLSearchParams;Object.entries(a).forEach(([d,p])=>{r.append(d,String(p))});const c=o.includes("?")?"&":"?";window.location.href=`${o}${c}${r.toString()}`},C=e=>{try{return new URL(window.location.href).searchParams.get(e)}catch{return null}},Y=({onError:e,isAuth:a,renderSignIn:o,routeCustomerOrder:r,routeGuestOrder:c})=>{const[d,p]=R("1"),[y,h]=R({text:"",type:"success"}),[S,T]=R(!1),f=j({invalidSearch:"Order.Errors.invalidSearch",email:"Order.OrderSearchForm.email",postcode:"Order.OrderSearchForm.postcode",number:"Order.OrderSearchForm.orderNumber"}),b=D(()=>{p(t=>t+1)},[]),g=D(async t=>{const i=C("orderRef"),u=i&&i.length>20;if(!t&&!i||!(t!=null&&t.number)&&!(t!=null&&t.token)&&!i)return null;if(a){const n=await v();(n==null?void 0:n.email)===t.email?m(r,{orderRef:t==null?void 0:t.number}):u||m(c,{orderRef:t.token})}else u||m(c,{orderRef:t==null?void 0:t.token})},[a,r,c]);I(()=>{const t=_.on("order/data",i=>{b(),g(i)},{eager:!0});return()=>{t==null||t.off(),b()}},[g,b]),I(()=>{const t=C("orderRef"),i=t&&t.length>20?t:null;t&&(i?m(c,{orderRef:t}):a?m(r,{orderRef:t}):o==null||o({render:!0,formValues:{number:t}}))},[a,r,c,o]);const U=B(()=>[{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:f.email,options:[],defaultValue:"",fieldType:E.TEXT,className:"",required:!0,orderNumber:1,name:"email",id:"email",code:"email"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:f.postcode,options:[],defaultValue:"",fieldType:E.TEXT,className:"",required:!0,orderNumber:2,name:"postcode",id:"postcode",code:"postcode"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:f.number,options:[],defaultValue:"",fieldType:E.TEXT,className:"",required:!0,orderNumber:3,name:"number",id:"number",code:"number"}],[f]);return{onSubmit:D(async(t,i,u)=>{if(!i)return null;T(!0);const l=z(t.target);await q(l).then(n=>{n||h({text:f.invalidSearch,type:"warning"}),u(),_.emit("order/data",n)}).catch(async n=>{var A;let w=!0;e==null||e({error:n.message});const N=a?await v():{email:""};(N==null?void 0:N.email)===(l==null?void 0:l.email)?(m(r,{orderRef:l.number}),u()):w=o==null?void 0:o({render:(A=n==null?void 0:n.message)==null?void 0:A.includes("Please login to view the order."),formValues:l}),w&&h({text:n.message,type:"warning"})}).finally(()=>{T(!1)})},[a,e,o,r,f]),inLineAlert:y,loading:S,normalizeFieldsConfig:U,key:d}},se=({className:e,isAuth:a,renderSignIn:o,routeCustomerOrder:r,routeGuestOrder:c,onError:d})=>{const{onSubmit:p,loading:y,inLineAlert:h,normalizeFieldsConfig:S,key:T}=Y({onError:d,isAuth:a,renderSignIn:o,routeCustomerOrder:r,routeGuestOrder:c});return s("div",{className:V(["dropin-order-search",e]),children:s(W,{onSubmit:p,loading:y,inLineAlert:h,fieldsConfig:S},T)})};export{se as OrderSearch,se as default};
