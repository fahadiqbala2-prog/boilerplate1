import{jsxs as M,jsx as l}from"@dropins/tools/preact-jsx-runtime.js";import{classes as D}from"@dropins/tools/lib.js";import{Card as _,InLineAlert as v,Icon as C,Button as x}from"@dropins/tools/components.js";import{F as U}from"../chunks/CustomerDetailsContent.js";import{useState as y,useCallback as I,useEffect as N,useMemo as k}from"@dropins/tools/preact-hooks.js";import*as O from"@dropins/tools/preact-compat.js";import{Text as R,useText as L}from"@dropins/tools/i18n.js";import{events as b}from"@dropins/tools/event-bus.js";import{c as B,g as G}from"../chunks/getCustomer.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";const H=e=>O.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},O.createElement("path",{vectorEffect:"non-scaling-stroke",fillRule:"evenodd",clipRule:"evenodd",d:"M1 20.8953L12.1922 1.5L23.395 20.8953H1ZM13.0278 13.9638L13.25 10.0377V9H11.25V10.0377L11.4722 13.9638H13.0278ZM11.2994 16V17.7509H13.2253V16H11.2994Z",fill:"currentColor"})),P=({onSubmit:e,loading:o,inLineAlert:n,fieldsConfig:t})=>M(_,{variant:"secondary",className:"dropin-order-search-form",children:[l("h2",{className:"dropin-order-search-form__title",children:l(R,{id:"Order.OrderSearchForm.title"})}),l("p",{children:l(R,{id:"Order.OrderSearchForm.description"})}),n.text?l(v,{"data-testid":"orderAlert",className:"dropin-order-search-form__alert",type:n.type,variant:"secondary",heading:n.text,icon:l(C,{source:H})}):null,l(U,{className:"dropin-order-search-form__wrapper",name:"orderSearchForm",loading:o,fieldsConfig:t,onSubmit:e,children:l("div",{className:"dropin-order-search-form__button-container",children:l(x,{className:"dropin-order-search-form__button",size:"medium",variant:"primary",type:"submit",disabled:o,children:l(R,{id:"Order.OrderSearchForm.button"})},"logIn")})})]});var T=(e=>(e.BOOLEAN="BOOLEAN",e.DATE="DATE",e.DATETIME="DATETIME",e.DROPDOWN="DROPDOWN",e.FILE="FILE",e.GALLERY="GALLERY",e.HIDDEN="HIDDEN",e.IMAGE="IMAGE",e.MEDIA_IMAGE="MEDIA_IMAGE",e.MULTILINE="MULTILINE",e.MULTISELECT="MULTISELECT",e.PRICE="PRICE",e.SELECT="SELECT",e.TEXT="TEXT",e.TEXTAREA="TEXTAREA",e.UNDEFINED="UNDEFINED",e.VISUAL="VISUAL",e.WEIGHT="WEIGHT",e.EMPTY="",e))(T||{});const V=e=>{if(!e)return null;const o=new FormData(e);if(e.querySelectorAll('input[type="checkbox"]').forEach(t=>{o.has(t.name)||o.set(t.name,"false"),t.checked&&o.set(t.name,"true")}),o&&typeof o.entries=="function"){const t=o.entries();if(t&&typeof t[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(t)))||{}}return{}},q=e=>typeof e=="function",f=(e,o)=>{if(!q(e))return;const n=e==null?void 0:e();console.log("`${url}?orderRef=${orderRef}`",`${n}?orderRef=${o}`),window.location.href=`${n}?orderRef=${o}`},X=({onError:e,isAuth:o,renderSignIn:n,routeCustomerOrderDetails:t,routeOrderDetails:d})=>{const[E,p]=y({text:"",type:"success"}),[S,h]=y(!1),[r,w]=y(null),m=L({invalidSearch:"Order.Errors.invalidSearch",email:"Order.OrderSearchForm.email",postcode:"Order.OrderSearchForm.postcode",number:"Order.OrderSearchForm.orderNumber"}),u=I(async i=>{try{return(await B()).email===i}catch{return!1}},[]);N(()=>{const i=b.on("order/data",a=>{w(a)},{eager:!0});return()=>{i==null||i.off()}},[]),N(()=>{const a=new URL(window.location.href).searchParams.get("orderRef"),s=a&&a.length>20?a:null;(async()=>{o&&r&&r.email&&await u(r==null?void 0:r.email)?f(t,r==null?void 0:r.number):s||r!=null&&r.token&&f(d,r==null?void 0:r.token)})()},[o,t,d,u,n,r]),N(()=>{const a=new URL(window.location.href).searchParams.get("orderRef"),s=a&&a.length>20?a:null,c=a&&a.length<20?a:null;s?f(d,s):c&&(o?f(t,c):(console.log("renderSignInrenderSignInrenderSignIn"),n({render:!0})))},[o,t,d,u,n]);const A=k(()=>[{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:m.email,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:1,name:"email",id:"email",code:"email"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:m.postcode,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:2,name:"postcode",id:"postcode",code:"postcode"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:m.number,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:3,name:"number",id:"number",code:"number"}],[m]);return{onSubmit:I(async(i,a)=>{if(!a)return null;h(!0);const s=V(i.target);await G(s).then(c=>{c||p({text:m.invalidSearch,type:"warning"}),console.log("guestOrder",c),b.emit("order/data",c)}).catch(async c=>{let g=!0;console.log("error DROPIN",c),e==null||e({error:c.message}),await u(s==null?void 0:s.email)?f(t,s.number):g=n==null?void 0:n({render:c.message.includes("Please login to view the order."),formValues:s}),g&&p({text:c.message,type:"warning"})}).finally(()=>{h(!1)})},[u,e,n,t,m]),inLineAlert:E,loading:S,normalizeFieldsConfig:A}},oe=({className:e,isAuth:o,renderSignIn:n,routeCustomerOrderDetails:t,routeOrderDetails:d,onError:E})=>{const{onSubmit:p,loading:S,inLineAlert:h,normalizeFieldsConfig:r}=X({onError:E,isAuth:o,renderSignIn:n,routeCustomerOrderDetails:t,routeOrderDetails:d});return console.log("!!!!!!!!!!!!!!isAuth",o),l("div",{className:D(["dropin-order-search",e]),children:l(P,{onSubmit:p,loading:S,inLineAlert:h,fieldsConfig:r})})};export{oe as OrderSearch,oe as default};
