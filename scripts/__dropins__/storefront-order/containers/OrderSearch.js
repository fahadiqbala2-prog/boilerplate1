import{jsxs as A,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{classes as w}from"@dropins/tools/lib.js";import{Card as M,InLineAlert as v,Icon as _,Button as C}from"@dropins/tools/components.js";import{F as U}from"../chunks/CustomerDetailsContent.js";import{useState as b,useCallback as N,useMemo as x}from"@dropins/tools/preact-hooks.js";import*as I from"@dropins/tools/preact-compat.js";import{Text as y,useText as L}from"@dropins/tools/i18n.js";import{events as V}from"@dropins/tools/event-bus.js";import{c as D,g as H}from"../chunks/getCustomer.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";const k=e=>I.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},I.createElement("path",{vectorEffect:"non-scaling-stroke",fillRule:"evenodd",clipRule:"evenodd",d:"M1 20.8953L12.1922 1.5L23.395 20.8953H1ZM13.0278 13.9638L13.25 10.0377V9H11.25V10.0377L11.4722 13.9638H13.0278ZM11.2994 16V17.7509H13.2253V16H11.2994Z",fill:"currentColor"})),P=({onSubmit:e,loading:r,inLineAlert:n,fieldsConfig:t})=>A(M,{variant:"secondary",className:"dropin-order-search-form",children:[s("h2",{className:"dropin-order-search-form__title",children:s(y,{id:"Order.OrderSearchForm.title"})}),s("p",{children:s(y,{id:"Order.OrderSearchForm.description"})}),n.text?s(v,{"data-testid":"orderAlert",className:"dropin-order-search-form__alert",type:n.type,variant:"secondary",heading:n.text,icon:s(_,{source:k})}):null,s(U,{className:"dropin-order-search-form__wrapper",name:"orderSearchForm",loading:r,fieldsConfig:t,onSubmit:e,children:s("div",{className:"dropin-order-search-form__button-container",children:s(C,{className:"dropin-order-search-form__button",size:"medium",variant:"primary",type:"submit",disabled:r,children:s(y,{id:"Order.OrderSearchForm.button"})},"logIn")})})]});var T=(e=>(e.BOOLEAN="BOOLEAN",e.DATE="DATE",e.DATETIME="DATETIME",e.DROPDOWN="DROPDOWN",e.FILE="FILE",e.GALLERY="GALLERY",e.HIDDEN="HIDDEN",e.IMAGE="IMAGE",e.MEDIA_IMAGE="MEDIA_IMAGE",e.MULTILINE="MULTILINE",e.MULTISELECT="MULTISELECT",e.PRICE="PRICE",e.SELECT="SELECT",e.TEXT="TEXT",e.TEXTAREA="TEXTAREA",e.UNDEFINED="UNDEFINED",e.VISUAL="VISUAL",e.WEIGHT="WEIGHT",e.EMPTY="",e))(T||{});const G=e=>{if(!e)return null;const r=new FormData(e);if(e.querySelectorAll('input[type="checkbox"]').forEach(t=>{r.has(t.name)||r.set(t.name,"false"),t.checked&&r.set(t.name,"true")}),r&&typeof r.entries=="function"){const t=r.entries();if(t&&typeof t[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(t)))||{}}return{}},h=(e,r)=>{if(typeof e!="function")return;const n=e();if(!r||Object.keys(r).length===0){window.location.href=n;return}const t=new URLSearchParams;Object.entries(r).forEach(([p,m])=>{t.append(p,String(m))});const i=n.includes("?")?"&":"?";window.location.href=`${n}${i}${t.toString()}`},X=e=>{try{return new URL(window.location.href).searchParams.get(e)}catch{return null}},B=({onError:e,isAuth:r,renderSignIn:n,routeCustomerOrder:t,routeGuestOrder:i})=>{const[p,m]=b({text:"",type:"success"}),[E,u]=b(!1),c=L({invalidSearch:"Order.Errors.invalidSearch",email:"Order.OrderSearchForm.email",postcode:"Order.OrderSearchForm.postcode",number:"Order.OrderSearchForm.orderNumber"});N(async a=>{const f=X("orderRef"),d=f&&f.length>20;if(!a&&!f||!(a!=null&&a.number)&&!(a!=null&&a.token)&&!f)return null;if(r){const o=await D();(o==null?void 0:o.email)===a.email?h(t,{orderRef:a==null?void 0:a.number}):d||h(i,{orderRef:a.token})}else d||h(i,{orderRef:a==null?void 0:a.token})},[r,t,i]);const R=x(()=>[{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:c.email,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:1,name:"email",id:"email",code:"email"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:c.postcode,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:2,name:"postcode",id:"postcode",code:"postcode"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:c.number,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:3,name:"number",id:"number",code:"number"}],[c]);return{onSubmit:N(async(a,f)=>{const d=a.target;if(!f)return null;u(!0);const l=G(a.target);await H(l).then(o=>{d.reset(),o||m({text:c.invalidSearch,type:"warning"}),V.emit("order/data",o)}).catch(async o=>{var O;let g=!0;e==null||e({error:o.message});const S=r?await D():{email:""};(S==null?void 0:S.email)===(l==null?void 0:l.email)?(d.reset(),h(t,{orderRef:l.number})):g=n==null?void 0:n({render:(O=o==null?void 0:o.message)==null?void 0:O.includes("Please login to view the order."),formValues:l}),g&&m({text:o.message,type:"warning"})}).finally(()=>{d.reset(),u(!1)})},[r,e,n,t,c.invalidSearch]),inLineAlert:p,loading:E,normalizeFieldsConfig:R}},re=({className:e,isAuth:r,renderSignIn:n,routeCustomerOrder:t,routeGuestOrder:i,onError:p})=>{const{onSubmit:m,loading:E,inLineAlert:u,normalizeFieldsConfig:c}=B({onError:p,isAuth:r,renderSignIn:n,routeCustomerOrder:t,routeGuestOrder:i});return s("div",{className:w(["dropin-order-search",e]),children:s(P,{onSubmit:m,loading:E,inLineAlert:u,fieldsConfig:c})})};export{re as OrderSearch,re as default};
