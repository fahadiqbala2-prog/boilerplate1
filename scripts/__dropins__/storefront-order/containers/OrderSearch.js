import{jsxs as L,jsx as i,Fragment as C}from"@dropins/tools/preact-jsx-runtime.js";import{classes as y}from"@dropins/tools/lib.js";import{Card as V,InLineAlert as q,Icon as U,Button as F,Field as w,Picker as H,Input as P,InputDate as X,Checkbox as j,TextArea as G}from"@dropins/tools/components.js";/* empty css                              */import{useRef as W,useState as A,useEffect as M,useCallback as R,useMemo as z}from"@dropins/tools/preact-hooks.js";import{Text as I,useText as g}from"@dropins/tools/i18n.js";import*as S from"@dropins/tools/preact-compat.js";import{useCallback as N}from"@dropins/tools/preact-compat.js";import{events as v}from"@dropins/tools/event-bus.js";import{c as _,g as Z}from"../chunks/getCustomer.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";const B=r=>S.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...r},S.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.8052 14.4968C10.8552 14.4968 9.9752 14.0268 9.4452 13.2368L9.4152 13.1868L9.3852 13.1268C8.1352 11.2268 7.5352 8.96681 7.6852 6.68681C7.7552 4.42681 9.6052 2.61681 11.8652 2.60681H12.0052C14.2752 2.47681 16.2152 4.21681 16.3452 6.47681C16.3452 6.55681 16.3452 6.62681 16.3452 6.70681C16.4852 8.94681 15.9052 11.1768 14.6852 13.0568L14.6052 13.1768C14.0552 13.9868 13.1352 14.4668 12.1652 14.4768H12.0052C11.9352 14.4768 11.8652 14.4868 11.7952 14.4868L11.8052 14.4968Z",stroke:"currentColor"}),S.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M4.3252 21.5469C4.3552 20.4169 4.4752 19.2869 4.6752 18.1769C4.8952 17.1669 6.4752 16.0269 8.9052 15.1569C9.2352 15.0369 9.4852 14.7869 9.5952 14.4569L9.8052 14.0269",stroke:"currentColor"}),S.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M14.425 14.4069L14.165 14.1569C14.375 14.5969 14.725 14.9569 15.155 15.1869C16.945 15.7969 19.125 16.9569 19.375 18.2069C19.585 19.3069 19.685 20.4269 19.675 21.5369",stroke:"currentColor"})),Y=r=>S.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...r},S.createElement("path",{vectorEffect:"non-scaling-stroke",fillRule:"evenodd",clipRule:"evenodd",d:"M1 20.8953L12.1922 1.5L23.395 20.8953H1ZM13.0278 13.9638L13.25 10.0377V9H11.25V10.0377L11.4722 13.9638H13.0278ZM11.2994 16V17.7509H13.2253V16H11.2994Z",fill:"currentColor"})),J=({onSubmit:r,loading:a,inLineAlert:s,fieldsConfig:l})=>L(V,{variant:"secondary",className:"dropin-order-search-form",children:[i("h2",{className:"dropin-order-search-form__title",children:i(I,{id:"Order.OrderSearchForm.title"})}),i("p",{children:i(I,{id:"Order.OrderSearchForm.description"})}),s.text?i(q,{"data-testid":"orderAlert",className:"dropin-order-search-form__alert",type:s.type,variant:"secondary",heading:s.text,icon:i(U,{source:Y})}):null,i(re,{className:"dropin-order-search-form__wrapper",name:"orderSearchForm",loading:a,fieldsConfig:l,onSubmit:r,children:i("div",{className:"dropin-order-search-form__button-container",children:i(F,{className:"dropin-order-search-form__button",size:"medium",variant:"primary",type:"submit",disabled:a,children:i(I,{id:"Order.OrderSearchForm.button"})},"logIn")})})]}),Q=r=>r.reduce((a,{code:s,required:l,defaultValue:o})=>(l&&(a[s]=o),a),{}),K=({fieldsConfig:r,onSubmit:a})=>{const{requiredFieldError:s}=g({requiredFieldError:"Order.Form.notifications.requiredFieldError"}),l=W(null),[o,u]=A({}),[f,d]=A({});M(()=>{if(u({}),!r||!r.length)return;const h=Q(r);u(h)},[r==null?void 0:r.length]),M(()=>()=>{var h;console.log("unmount"),u({}),(h=l.current)==null||h.reset()},[]);const b=R((h,e)=>{const t=r.find(c=>c.code===h);return t!=null&&t.required&&!e?s:""},[r,s]),E=R(h=>{const{name:e,value:t,type:n,checked:c}=h==null?void 0:h.target,p=n==="checkbox"?c:t;u(T=>({...T,[e]:p}))},[]),m=R(h=>{const{name:e,value:t,type:n,checked:c}=h==null?void 0:h.target,p=n==="checkbox"?c:t;d(T=>({...T,[e]:b(e,p)}))},[b]),$=R(h=>{h.preventDefault();let e=!0,t={},n=null;for(const[c,p]of Object.entries(o)){const T=b(c,p);T&&(t[c]=T,e=!1,n||(n=c))}if(d(t),n&&l.current){const c=l.current.elements.namedItem(n);c==null||c.focus()}a==null||a(h,e)},[o,b,a]);return{formData:o,errors:f,formRef:l,handleChange:E,handleBlur:m,handleSubmit:$}},ee=({loading:r,values:a,fields:s=[],errors:l,className:o="",onChange:u,onBlur:f})=>{const d=`${o}__item`,b=N((e,t,n)=>{const c=e.options.map(p=>({text:p.label,value:p.value}));return i(w,{error:n,className:y([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e.is_hidden],e.className]),"data-testid":`${o}--${e.id}`,disabled:r,children:i(H,{name:e.id,floatingLabel:`${e.label} ${e.required?"*":""}`,placeholder:e.label,"aria-label":e.label,options:c,onBlur:f,handleSelect:u,value:t||e.defaultValue})},e.id)},[o,r,d,f,u]),E=N((e,t,n)=>{const c=e.id==="email",p=c?i(B,{}):void 0,T=c?"username":"";return i(w,{error:n,className:y([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e==null?void 0:e.is_hidden],e.className]),"data-testid":`${o}--${e.id}`,disabled:r,children:i(P,{"aria-label":e.label,"aria-required":e.required,autoComplete:T,icon:p,type:"text",name:e.id,value:t||e.defaultValue,placeholder:e.label,floatingLabel:`${e.label} ${e.required?"*":""}`,onBlur:f,onChange:u})},e.id)},[o,r,d,f,u]),m=N((e,t,n)=>i(w,{error:n,className:y([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e.is_hidden],e.className]),"data-testid":`${o}--${e.id}`,disabled:r,children:i(X,{type:"text",name:e.id,value:t||e.defaultValue,placeholder:e.label,floatingLabel:`${e.label} ${e.required?"*":""}`,onBlur:f,onChange:u})},e.id),[o,r,d,f,u]),$=N((e,t,n)=>i(w,{error:n,className:y([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e.is_hidden],e.className]),"data-testid":`${o}--${e.id}`,disabled:r,children:i(j,{name:e.id,checked:t||e.defaultValue,placeholder:e.label,label:`${e.label} ${e.required?"*":""}`,onBlur:f,onChange:u})},e.id),[o,r,d,f,u]),h=N((e,t,n)=>i(w,{error:n,className:y([d,`${d}--${e.id}`,[`${d}--${e.id}-hidden`,e.is_hidden],e.className]),"data-testid":`${o}--${e.id}`,disabled:r,children:i(G,{type:"text",name:e.id,value:t===void 0?e.defaultValue:t,label:`${e.label} ${e.required?"*":""}`,onBlur:f,onChange:u})},e.id),[o,r,d,f,u]);return s.length?i(C,{children:s.map(e=>{var c;const t=(l==null?void 0:l[e.id])??"",n=(a==null?void 0:a[e.id])??"";switch(e.fieldType){case"TEXT":return(c=e==null?void 0:e.options)!=null&&c.length?b(e,n,t):E(e,n,t);case"MULTILINE":return E(e,n,t);case"SELECT":return b(e,n,t);case"DATE":return m(e,n,t);case"BOOLEAN":return $(e,n,t);case"TEXTAREA":return h(e,n,t);default:return null}})}):null},re=({name:r,loading:a,children:s,className:l="defaultForm",fieldsConfig:o,onSubmit:u})=>{const{formData:f,errors:d,formRef:b,handleChange:E,handleBlur:m,handleSubmit:$}=K({fieldsConfig:o,onSubmit:u});return L("form",{className:y(["dropin-form",l]),onSubmit:$,name:r,ref:b,children:[i(ee,{className:l,loading:a,fields:o,onChange:E,onBlur:m,errors:d,values:f}),s]})};var O=(r=>(r.BOOLEAN="BOOLEAN",r.DATE="DATE",r.DATETIME="DATETIME",r.DROPDOWN="DROPDOWN",r.FILE="FILE",r.GALLERY="GALLERY",r.HIDDEN="HIDDEN",r.IMAGE="IMAGE",r.MEDIA_IMAGE="MEDIA_IMAGE",r.MULTILINE="MULTILINE",r.MULTISELECT="MULTISELECT",r.PRICE="PRICE",r.SELECT="SELECT",r.TEXT="TEXT",r.TEXTAREA="TEXTAREA",r.UNDEFINED="UNDEFINED",r.VISUAL="VISUAL",r.WEIGHT="WEIGHT",r.EMPTY="",r))(O||{});const ae=r=>{if(!r)return null;const a=new FormData(r);if(r.querySelectorAll('input[type="checkbox"]').forEach(l=>{a.has(l.name)||a.set(l.name,"false"),l.checked&&a.set(l.name,"true")}),a&&typeof a.entries=="function"){const l=a.entries();if(l&&typeof l[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(l)))||{}}return{}},D=(r,a)=>{if(typeof r!="function")return;const s=r();if(!a||Object.keys(a).length===0){window.location.href=s;return}const l=new URLSearchParams;Object.entries(a).forEach(([u,f])=>{l.append(u,String(f))});const o=s.includes("?")?"&":"?";window.location.href=`${s}${o}${l.toString()}`},x=r=>{try{return new URL(window.location.href).searchParams.get(r)}catch{return null}},te=({onError:r,isAuth:a,renderSignIn:s,routeCustomerOrder:l,routeGuestOrder:o})=>{const[u,f]=A({text:"",type:"success"}),[d,b]=A(!1),E=g({invalidSearch:"Order.Errors.invalidSearch",email:"Order.OrderSearchForm.email",postcode:"Order.OrderSearchForm.postcode",number:"Order.OrderSearchForm.orderNumber"}),m=R(async e=>{const t=x("orderRef"),n=t&&t.length>20;if(!e&&!t||!(e!=null&&e.number)&&!(e!=null&&e.token)&&!t)return null;if(a){const p=await _();(p==null?void 0:p.email)===e.email?D(l,{orderRef:e==null?void 0:e.number}):n||D(o,{orderRef:e.token})}else n||D(o,{orderRef:e==null?void 0:e.token})},[a,l,o]);M(()=>{v.on("order/data",e=>{m(e)},{eager:!0})},[m]),M(()=>{const e=x("orderRef"),t=e&&e.length>20?e:null;e&&(t?D(o,{orderRef:e}):a?D(l,{orderRef:e}):s==null||s({render:!0,formValues:{number:e}}))},[a,l,o,s]);const $=z(()=>[{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:E.email,options:[],defaultValue:"",fieldType:O.TEXT,className:"",required:!0,orderNumber:1,name:"email",id:"email",code:"email"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:E.postcode,options:[],defaultValue:"",fieldType:O.TEXT,className:"",required:!0,orderNumber:2,name:"postcode",id:"postcode",code:"postcode"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:E.number,options:[],defaultValue:"",fieldType:O.TEXT,className:"",required:!0,orderNumber:3,name:"number",id:"number",code:"number"}],[E]);return{onSubmit:R(async(e,t)=>{if(!t)return null;b(!0);const n=ae(e.target);await Z(n).then(c=>{c||f({text:E.invalidSearch,type:"warning"}),v.emit("order/data",c)}).catch(async c=>{var k;let p=!0;r==null||r({error:c.message});const T=a?await _():{email:""};(T==null?void 0:T.email)===(n==null?void 0:n.email)?(p=!1,D(l,{orderRef:n.number})):p=s==null?void 0:s({render:(k=c==null?void 0:c.message)==null?void 0:k.includes("Please login to view the order."),formValues:n}),p&&f({text:c.message,type:"warning"})}).finally(()=>{b(!1)})},[a,r,s,l,E.invalidSearch]),inLineAlert:u,loading:d,normalizeFieldsConfig:$}},be=({className:r,isAuth:a,renderSignIn:s,routeCustomerOrder:l,routeGuestOrder:o,onError:u})=>{const{onSubmit:f,loading:d,inLineAlert:b,normalizeFieldsConfig:E}=te({onError:u,isAuth:a,renderSignIn:s,routeCustomerOrder:l,routeGuestOrder:o});return i("div",{className:y(["dropin-order-search",r]),children:i(J,{onSubmit:f,loading:d,inLineAlert:b,fieldsConfig:E})})};export{be as OrderSearch,be as default};
