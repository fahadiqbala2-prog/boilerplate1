import{jsxs as A,jsx as n}from"@dropins/tools/preact-jsx-runtime.js";import{classes as M}from"@dropins/tools/lib.js";import{Card as D,InLineAlert as _,Icon as v,Button as C}from"@dropins/tools/components.js";import{F as x}from"../chunks/CustomerDetailsContent.js";import{useState as N,useCallback as b,useEffect as O,useMemo as U}from"@dropins/tools/preact-hooks.js";import*as R from"@dropins/tools/preact-compat.js";import{Text as y,useText as k}from"@dropins/tools/i18n.js";import{events as I}from"@dropins/tools/event-bus.js";import{c as L,g as V}from"../chunks/getCustomer.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";const B=e=>R.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},R.createElement("path",{vectorEffect:"non-scaling-stroke",fillRule:"evenodd",clipRule:"evenodd",d:"M1 20.8953L12.1922 1.5L23.395 20.8953H1ZM13.0278 13.9638L13.25 10.0377V9H11.25V10.0377L11.4722 13.9638H13.0278ZM11.2994 16V17.7509H13.2253V16H11.2994Z",fill:"currentColor"})),G=({onSubmit:e,loading:a,inLineAlert:o,fieldsConfig:t})=>A(D,{variant:"secondary",className:"dropin-order-search-form",children:[n("h2",{className:"dropin-order-search-form__title",children:n(y,{id:"Order.OrderSearchForm.title"})}),n("p",{children:n(y,{id:"Order.OrderSearchForm.description"})}),o.text?n(_,{"data-testid":"orderAlert",className:"dropin-order-search-form__alert",type:o.type,variant:"secondary",heading:o.text,icon:n(v,{source:B})}):null,n(x,{className:"dropin-order-search-form__wrapper",name:"orderSearchForm",loading:a,fieldsConfig:t,onSubmit:e,children:n("div",{className:"dropin-order-search-form__button-container",children:n(C,{className:"dropin-order-search-form__button",size:"medium",variant:"primary",type:"submit",disabled:a,children:n(y,{id:"Order.OrderSearchForm.button"})},"logIn")})})]});var T=(e=>(e.BOOLEAN="BOOLEAN",e.DATE="DATE",e.DATETIME="DATETIME",e.DROPDOWN="DROPDOWN",e.FILE="FILE",e.GALLERY="GALLERY",e.HIDDEN="HIDDEN",e.IMAGE="IMAGE",e.MEDIA_IMAGE="MEDIA_IMAGE",e.MULTILINE="MULTILINE",e.MULTISELECT="MULTISELECT",e.PRICE="PRICE",e.SELECT="SELECT",e.TEXT="TEXT",e.TEXTAREA="TEXTAREA",e.UNDEFINED="UNDEFINED",e.VISUAL="VISUAL",e.WEIGHT="WEIGHT",e.EMPTY="",e))(T||{});const H=e=>{if(!e)return null;const a=new FormData(e);if(e.querySelectorAll('input[type="checkbox"]').forEach(t=>{a.has(t.name)||a.set(t.name,"false"),t.checked&&a.set(t.name,"true")}),a&&typeof a.entries=="function"){const t=a.entries();if(t&&typeof t[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(t)))||{}}return{}},P=e=>typeof e=="function",f=(e,a)=>{if(!P(e))return;const o=e==null?void 0:e();window.location.href=`${o}?orderRef=${a}`},q=({onError:e,isAuth:a,renderSignIn:o,routeCustomerOrderDetails:t,routeOrderDetails:m})=>{const[E,p]=N({text:"",type:"success"}),[S,h]=N(!1),i=k({invalidSearch:"Order.Errors.invalidSearch",email:"Order.OrderSearchForm.email",postcode:"Order.OrderSearchForm.postcode",number:"Order.OrderSearchForm.orderNumber"}),u=b(async l=>{try{return(await L()).email===l}catch{return!1}},[]);O(()=>{const l=I.on("order/data",r=>{const s=new URL(window.location.href).searchParams.get("orderRef"),d=s&&s.length>20?s:null;(async()=>{a&&r&&r.email&&await u(r==null?void 0:r.email)?f(t,r==null?void 0:r.number):d||r!=null&&r.token&&f(m,r==null?void 0:r.token)})()},{eager:!0});return()=>{l==null||l.off()}},[u,a,t,m]),O(()=>{const r=new URL(window.location.href).searchParams.get("orderRef"),c=r&&r.length>20?r:null;r&&(c?f(m,r):a?f(t,r):o({render:!0,formValues:{number:r}}))},[a,t,m,u,o]);const g=U(()=>[{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:i.email,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:1,name:"email",id:"email",code:"email"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:i.postcode,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:2,name:"postcode",id:"postcode",code:"postcode"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:i.number,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:3,name:"number",id:"number",code:"number"}],[i]);return{onSubmit:b(async(l,r)=>{if(!r)return null;h(!0);const c=H(l.target);await V(c).then(s=>{s||p({text:i.invalidSearch,type:"warning"}),I.emit("order/data",s)}).catch(async s=>{let d=!0;e==null||e({error:s.message}),await u(c==null?void 0:c.email)?f(t,c.number):d=o==null?void 0:o({render:s.message.includes("Please login to view the order."),formValues:c}),d&&p({text:s.message,type:"warning"})}).finally(()=>{h(!1)})},[u,e,o,t,i]),inLineAlert:E,loading:S,normalizeFieldsConfig:g}},re=({className:e,isAuth:a,renderSignIn:o,routeCustomerOrderDetails:t,routeOrderDetails:m,onError:E})=>{const{onSubmit:p,loading:S,inLineAlert:h,normalizeFieldsConfig:i}=q({onError:E,isAuth:a,renderSignIn:o,routeCustomerOrderDetails:t,routeOrderDetails:m});return n("div",{className:M(["dropin-order-search",e]),children:n(G,{onSubmit:p,loading:S,inLineAlert:h,fieldsConfig:i})})};export{re as OrderSearch,re as default};
