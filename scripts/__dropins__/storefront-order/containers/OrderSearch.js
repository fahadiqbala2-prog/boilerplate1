import{jsxs as U,jsx as c}from"@dropins/tools/preact-jsx-runtime.js";import{classes as C}from"@dropins/tools/lib.js";import{Card as x,InLineAlert as V,Icon as L,Button as k}from"@dropins/tools/components.js";import{F as H}from"../chunks/CustomerDetailsContent.js";import{useRef as P,useState as g,useCallback as O,useEffect as w,useMemo as X}from"@dropins/tools/preact-hooks.js";import*as A from"@dropins/tools/preact-compat.js";import{Text as b,useText as B}from"@dropins/tools/i18n.js";import{events as I}from"@dropins/tools/event-bus.js";import{c as M,g as j}from"../chunks/getCustomer.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";const q=e=>A.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},A.createElement("path",{vectorEffect:"non-scaling-stroke",fillRule:"evenodd",clipRule:"evenodd",d:"M1 20.8953L12.1922 1.5L23.395 20.8953H1ZM13.0278 13.9638L13.25 10.0377V9H11.25V10.0377L11.4722 13.9638H13.0278ZM11.2994 16V17.7509H13.2253V16H11.2994Z",fill:"currentColor"})),G=({onSubmit:e,loading:r,inLineAlert:o,fieldsConfig:a})=>U(x,{variant:"secondary",className:"dropin-order-search-form",children:[c("h2",{className:"dropin-order-search-form__title",children:c(b,{id:"Order.OrderSearchForm.title"})}),c("p",{children:c(b,{id:"Order.OrderSearchForm.description"})}),o.text?c(V,{"data-testid":"orderAlert",className:"dropin-order-search-form__alert",type:o.type,variant:"secondary",heading:o.text,icon:c(L,{source:q})}):null,c(H,{className:"dropin-order-search-form__wrapper",name:"orderSearchForm",loading:r,fieldsConfig:a,onSubmit:e,children:c("div",{className:"dropin-order-search-form__button-container",children:c(k,{className:"dropin-order-search-form__button",size:"medium",variant:"primary",type:"submit",disabled:r,children:c(b,{id:"Order.OrderSearchForm.button"})},"logIn")})})]});var E=(e=>(e.BOOLEAN="BOOLEAN",e.DATE="DATE",e.DATETIME="DATETIME",e.DROPDOWN="DROPDOWN",e.FILE="FILE",e.GALLERY="GALLERY",e.HIDDEN="HIDDEN",e.IMAGE="IMAGE",e.MEDIA_IMAGE="MEDIA_IMAGE",e.MULTILINE="MULTILINE",e.MULTISELECT="MULTISELECT",e.PRICE="PRICE",e.SELECT="SELECT",e.TEXT="TEXT",e.TEXTAREA="TEXTAREA",e.UNDEFINED="UNDEFINED",e.VISUAL="VISUAL",e.WEIGHT="WEIGHT",e.EMPTY="",e))(E||{});const W=e=>{if(!e)return null;const r=new FormData(e);if(e.querySelectorAll('input[type="checkbox"]').forEach(a=>{r.has(a.name)||r.set(a.name,"false"),a.checked&&r.set(a.name,"true")}),r&&typeof r.entries=="function"){const a=r.entries();if(a&&typeof a[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(a)))||{}}return{}},d=(e,r)=>{if(typeof e!="function")return;const o=e();if(!r||Object.keys(r).length===0){window.location.href=o;return}const a=new URLSearchParams;Object.entries(r).forEach(([l,p])=>{a.append(l,String(p))});const i=o.includes("?")?"&":"?";window.location.href=`${o}${i}${a.toString()}`},_=e=>{try{return new URL(window.location.href).searchParams.get(e)}catch{return null}},z=({onError:e,isAuth:r,renderSignIn:o,routeCustomerOrder:a,routeGuestOrder:i})=>{const l=P(null),[p,u]=g({text:"",type:"success"}),[y,h]=g(!1),m=B({invalidSearch:"Order.Errors.invalidSearch",email:"Order.OrderSearchForm.email",postcode:"Order.OrderSearchForm.postcode",number:"Order.OrderSearchForm.orderNumber"}),N=O(async t=>{const n=_("orderRef"),T=n&&n.length>20;if(!t&&!n||!(t!=null&&t.number)&&!(t!=null&&t.token)&&!n)return null;if(r){const s=await M();(s==null?void 0:s.email)===t.email?d(a,{orderRef:t==null?void 0:t.number}):T||d(i,{orderRef:t.token})}else T||d(i,{orderRef:t==null?void 0:t.token})},[r,a,i]);w(()=>{const t=I.on("order/data",n=>{N(n)},{eager:!0});return()=>{var n;t==null||t.off(),(n=l==null?void 0:l.current)==null||n.reset()}},[N]),w(()=>{const t=_("orderRef"),n=t&&t.length>20?t:null;t&&(n?d(i,{orderRef:t}):r?d(a,{orderRef:t}):o==null||o({render:!0,formValues:{number:t}}))},[r,a,i,o]);const v=X(()=>[{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:m.email,options:[],defaultValue:"",fieldType:E.TEXT,className:"",required:!0,orderNumber:1,name:"email",id:"email",code:"email"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:m.postcode,options:[],defaultValue:"",fieldType:E.TEXT,className:"",required:!0,orderNumber:2,name:"postcode",id:"postcode",code:"postcode"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:m.number,options:[],defaultValue:"",fieldType:E.TEXT,className:"",required:!0,orderNumber:3,name:"number",id:"number",code:"number"}],[m]);return{onSubmit:O(async(t,n)=>{const T=t.target;if(l.current=T,!n)return null;h(!0);const f=W(t.target);await j(f).then(s=>{s||u({text:m.invalidSearch,type:"warning"}),I.emit("order/data",s)}).catch(async s=>{var D;let R=!0;e==null||e({error:s.message});const S=r?await M():{email:""};(S==null?void 0:S.email)===(f==null?void 0:f.email)?d(a,{orderRef:f.number}):R=o==null?void 0:o({render:(D=s==null?void 0:s.message)==null?void 0:D.includes("Please login to view the order."),formValues:f}),R&&u({text:s.message,type:"warning"})}).finally(()=>{h(!1)})},[r,e,o,a,m.invalidSearch]),inLineAlert:p,loading:y,normalizeFieldsConfig:v}},ne=({className:e,isAuth:r,renderSignIn:o,routeCustomerOrder:a,routeGuestOrder:i,onError:l})=>{const{onSubmit:p,loading:u,inLineAlert:y,normalizeFieldsConfig:h}=z({onError:l,isAuth:r,renderSignIn:o,routeCustomerOrder:a,routeGuestOrder:i});return c("div",{className:C(["dropin-order-search",e]),children:c(G,{onSubmit:p,loading:u,inLineAlert:y,fieldsConfig:h})})};export{ne as OrderSearch,ne as default};
