/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as c,jsxs as S,Fragment as g}from"@dropins/tools/preact-jsx-runtime.js";import{Card as x,Header as $,Button as y,InLineAlert as U,Modal as b}from"@dropins/tools/components.js";import"../chunks/OrderCancel.js";import{f as F}from"../chunks/returnOrdersHelper.js";import{classes as E,Slot as P}from"@dropins/tools/lib.js";import{f as I}from"../chunks/formatDateToLocale.js";import{useState as h,useEffect as T}from"@dropins/tools/preact-hooks.js";import{events as w}from"@dropins/tools/event-bus.js";import{useMemo as K,useState as G}from"@dropins/tools/preact-compat.js";import{r as V}from"../chunks/redirectTo.js";import"@dropins/tools/preact.js";import{O as k}from"../chunks/OrderCancelForm.js";import{useText as O,Text as M}from"@dropins/tools/i18n.js";import{C as q}from"../chunks/OrderLoaders.js";import{G as H}from"../chunks/getGuestOrder.graphql.js";import{f as W,h as j}from"../chunks/fetch-graphql.js";import{b as J}from"../chunks/transform-order-details.js";import{g as z}from"../chunks/getStoreConfig.js";import"../chunks/requestGuestOrderCancel.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/convertCase.js";const A={pending:"orderPending",shiping:"orderShipped",complete:"orderComplete",processing:"orderProcessing","on hold":"orderOnHold",canceled:"orderCanceled","suspected fraud":"orderSuspectedFraud","payment Review":"orderPaymentReview","order received":"orderReceived","guest order cancellation requested":"guestOrderCancellationRequested"},B=({slots:t,title:r,status:n,orderData:e,routeCreateReturn:o})=>{var v;const i=!!(e!=null&&e.returnNumber),s=String(n).toLocaleLowerCase(),a=(v=e==null?void 0:e.returns)==null?void 0:v[0],l=(a==null?void 0:a.returnStatus)??"",d=(a==null?void 0:a.createdReturnAt)??"",m=O(`Order.OrderStatusContent.${A[s]}.title`),f=O(`Order.OrderStatusContent.${A[s]}.message`),p=O(`Order.OrderStatusContent.${A[s]}.messageWithoutDate`),u=O({title:`Order.OrderStatusContent.resturnStatus.${F(l)}`,returnMessage:"Order.OrderStatusContent.returnMessage"});if(!n)return c("div",{});const C=e!=null&&e.orderStatusChangeDate?f==null?void 0:f.message.replace("{DATE}",e==null?void 0:e.orderStatusChangeDate):p.messageWithoutDate,_=(u==null?void 0:u.returnMessage.replace("{ORDER_CREATE_DATE}",I(e==null?void 0:e.orderDate)).replace("{RETURN_CREATE_DATE}",I(d)))??"",N=i?r??u.title:r??m.title;return S(x,{className:"order-order-status-content",variant:"secondary",children:[c($,{title:N}),S("div",{className:"order-order-status-content__wrapper",children:[c("div",{className:E(["order-order-status-content__wrapper-description",["order-order-status-content__wrapper-description--actions-slot",!!(t!=null&&t.OrderActions)]]),children:c("p",{children:i?_:C})}),c(X,{orderData:e,slots:t,routeCreateReturn:o})]})]})};var R=(t=>(t.CANCEL="CANCEL",t.RETURN="RETURN",t.REORDER="REORDER",t))(R||{});const Q=({orderData:t})=>{const[r,n]=h(t),[e,o]=h(t==null?void 0:t.status);return T(()=>{const i=w.on("order/data",s=>{n(s),o(s.status)},{eager:!0});return()=>{i==null||i.off()}},[]),{orderStatus:e,order:r}},X=({className:t,orderData:r,slots:n,routeCreateReturn:e})=>{const o=O({cancel:"Order.OrderStatusContent.actions.cancel",createReturn:"Order.OrderStatusContent.actions.createReturn",createAnotherReturn:"Order.OrderStatusContent.actions.createAnotherReturn",reorder:"Order.OrderStatusContent.actions.reorder"}),i=K(()=>{const s=r==null?void 0:r.availableActions,a=!!(s!=null&&s.length),l=!!(r!=null&&r.returnNumber),d=()=>{V(e,{},r)};return c(g,{children:n!=null&&n.OrderActions?c(P,{"data-testid":"OrderActionsSlot",name:"OrderCanceledActions",slot:n==null?void 0:n.OrderActions,context:r}):c("div",{"data-testid":"availableActionsList",className:E(["order-order-actions__wrapper",["order-order-actions__wrapper--empty",!a]]),children:s==null?void 0:s.map(m=>{switch(m){case R.CANCEL:return c(g,{children:l?null:!!r&&c(ee,{orderRef:r.token??atob(r.id)})});case R.RETURN:return c(y,{variant:"secondary",onClick:d,children:l?o.createAnotherReturn:o.createReturn});case R.REORDER:return c(g,{children:l?null:c(y,{variant:"secondary",children:o.reorder})})}})})})},[r,e,n==null?void 0:n.OrderActions,o]);return c("div",{className:E(["order-order-actions",t]),children:i})},L=()=>{const[t,r]=h(null);return T(()=>{const n=sessionStorage.getItem("orderStoreConfig"),e=n?JSON.parse(n):null;e?r(e):z().then(o=>{o&&(sessionStorage.setItem("orderStoreConfig",JSON.stringify(o)),r(o))})},[]),t},Y=`
  mutation CONFIRM_CANCEL_ORDER_MUTATION(
      $orderId: ID!,
      $confirmationKey: String!
    ) {
    confirmCancelOrder(input: {
      order_id: $orderId,
      confirmation_key: $confirmationKey
    }) {
      order {
        ...guestOrderData
      }
      errorV2 {
        message
        code
      }
    }
  }
${H}
`,Z=async(t,r)=>W(Y,{variables:{orderId:t,confirmationKey:r}}).then(async({errors:n,data:e})=>{var s,a,l,d;const o=[...(s=e==null?void 0:e.confirmCancelOrder)!=null&&s.errorV2?[(a=e==null?void 0:e.confirmCancelOrder)==null?void 0:a.errorV2]:[],...n??[]];let i=null;return(l=e==null?void 0:e.confirmCancelOrder)!=null&&l.order&&(i=J((d=e==null?void 0:e.confirmCancelOrder)==null?void 0:d.order),w.emit("order/data",i)),o.length>0?j(o):i}),D=({enableOrderCancellation:t})=>{const r=O({orderCancelled:"Order.OrderStatusContent.orderCanceled.message"}),[n,e]=h({text:"",status:void 0});return T(()=>{if(!t)return;const o=new URLSearchParams(window.location.search),i=o.get("orderId"),s=o.get("confirmationKey");i&&s&&Z(atob(i),s).then(()=>{e({text:r.orderCancelled,status:"success"})}).catch(a=>{e({text:a.message,status:"warning"})})},[t,r.orderCancelled]),{confirmOrderCancellation:n}},_e=({slots:t,orderData:r,className:n,statusTitle:e,status:o,routeCreateReturn:i})=>{const{orderStatus:s,order:a}=Q({orderData:r}),[l,d]=G(!1),m=()=>{d(!0);const C=new URL(window.location.href),_=C.searchParams.get("orderId"),N=C.searchParams.get("confirmationKey");_&&N&&(C.searchParams.delete("orderId"),C.searchParams.delete("confirmationKey"),window.history.replaceState({},document.title,C.toString()))},f=O({cancelOrder:"Order.OrderStatusContent.actions.cancel"}),p=L(),{confirmOrderCancellation:u}=D({enableOrderCancellation:p==null?void 0:p.orderCancellationEnabled});return S("div",{className:E(["order-order-status",n]),children:[!l&&(u==null?void 0:u.status)!==void 0&&c(U,{heading:f.cancelOrder,onDismiss:m,description:u.text,type:u.status}),a?c(B,{title:e,status:o||s,slots:t,orderData:a,routeCreateReturn:i}):c(q,{withCard:!1})]})},ee=({orderRef:t})=>{const[r,n]=h(!1),e=()=>{n(!0)},o=()=>{n(!1)},i=L(),s=(i==null?void 0:i.orderCancellationReasons)??[],a=l=>l.map((d,m)=>({text:d==null?void 0:d.description,value:m.toString()}));return w.on("order/data",l=>{const d=String(l.status).toLocaleLowerCase();(d==="guest order cancellation requested"||d==="canceled")&&o()}),S(g,{children:[c(y,{variant:"secondary",onClick:e,"data-testid":"cancel-button",children:c(M,{id:"Order.OrderStatusContent.actions.cancel"})}),r&&c(b,{centered:!0,size:"medium",onClose:o,className:"order-order-cancel__modal",title:c("h2",{className:"order-order-cancel__title",children:c(M,{id:"Order.OrderCancelForm.title"})}),"data-testid":"order-cancellation-reasons-modal",children:c(k,{orderRef:t,cancelReasons:a(s)})})]})};export{_e as OrderStatus,_e as default};
