{"version":3,"file":"BillToShippingAddress__FCUbfsa2Cu.js","sources":["../../src/components/BillToShippingAddress/BillToShippingAddress.tsx","../../src/components/BillToShippingAddress/BillToShippingAddressSkeleton.tsx","../../src/containers/BillToShippingAddress/constants.ts","../../src/containers/BillToShippingAddress/BillToShippingAddress.tsx"],"sourcesContent":["import { FunctionComponent } from 'preact';\nimport { classes } from '@adobe/elsie/lib';\nimport { Checkbox, CheckboxProps } from '@adobe/elsie/components';\nimport { BillToShippingAddressSkeleton } from '@/checkout/components/BillToShippingAddress';\nimport '@/checkout/components/BillToShippingAddress/BillToShippingAddress.css';\nimport { useText } from '@adobe/elsie/i18n';\n\nexport interface BillToShippingAddressProps\n  extends Omit<CheckboxProps, 'name' | 'label'> {\n  isInitialized?: boolean;\n}\n\nexport const BillToShippingAddress: FunctionComponent<\n  BillToShippingAddressProps\n> = ({ className, isInitialized = true, checked = true, ...props }) => {\n  const translations = useText({\n    title: 'Checkout.BillToShippingAddress.title',\n  });\n\n  if (!isInitialized) return <BillToShippingAddressSkeleton />;\n\n  return (\n    <div className={classes(['checkout-bill-to-shipping-address', className])}>\n      <Checkbox\n        data-testid=\"bill-to-shipping-checkbox\"\n        className=\"checkout-bill-to-shipping-address__checkbox\"\n        checked={checked}\n        name=\"checkout-bill-to-shipping-address__checkbox\"\n        label={translations.title}\n        {...props}\n      />\n    </div>\n  );\n};\n","import { FunctionComponent } from 'preact';\nimport { Skeleton, SkeletonRow } from '@adobe/elsie/components';\n\nexport const BillToShippingAddressSkeleton: FunctionComponent = () => {\n  return (\n    <Skeleton className=\"bill-to-shipping-address__skeleton\">\n      <SkeletonRow variant=\"row\" size=\"small\" />\n    </Skeleton>\n  );\n};\n","export const BILL_TO_SHIPPING_KEY = 'is_bill_to_shipping_address';\n","import { FormFields, setBillingAddress } from '@/checkout/api';\nimport { BillToShippingAddress as BillToShippingAddressComponent } from '@/checkout/components/BillToShippingAddress';\nimport {\n  IsBillToShipping,\n  cartSignal,\n  isBillToShippingSignal,\n} from '@/checkout/signals';\nimport { Container } from '@adobe/elsie/lib';\nimport { Signal } from '@preact/signals-core';\nimport { useEffect, useState } from 'preact/compat';\nimport { BILL_TO_SHIPPING_KEY } from './constants';\nimport { useAddressFormFields } from '@/checkout/context/address-form-fields';\nimport { CheckboxProps } from '@adobe/elsie/src/components';\nimport {\n  ShippingAddress,\n  BillingAddress,\n} from '@/checkout/data/models/address';\n\ntype Address = BillingAddress | ShippingAddress[];\n\nfunction compareFields(first: Address, second: Address, field: keyof Address) {\n  const firstValue = first[field];\n  const secondValue = second[field];\n\n  if (firstValue === undefined && secondValue === undefined) return true;\n  if (firstValue === null && secondValue === null) return true;\n\n  if (typeof firstValue === 'object' && typeof secondValue === 'object') {\n    return JSON.stringify(firstValue) === JSON.stringify(secondValue);\n  }\n\n  return firstValue === secondValue;\n}\n\nexport function compareAddresses(\n  addressFormFields: FormFields,\n  first: BillingAddress | undefined,\n  second: ShippingAddress | undefined\n) {\n  if (!first && !second) return true;\n  if (!first || !second) return false;\n\n  return addressFormFields.every((field) => {\n    const fieldCode = field.code as keyof Address;\n    return compareFields(first, second, fieldCode);\n  });\n}\n\nconst useInitialState = ({\n  isBillToShipping,\n}: {\n  isBillToShipping: Signal<IsBillToShipping>;\n}) => {\n  const [isInitialized, setIsInitialized] = useState(false);\n  const { fields } = useAddressFormFields();\n  const cartData = cartSignal.value.data;\n  const hasCartData = !!cartData;\n  const billingAddress = cartData?.billingAddress;\n  const shippingAddress = cartData?.shippingAddresses?.[0];\n\n  useEffect(() => {\n    if (!fields) return;\n\n    const localIsBillToShipping = localStorage.getItem(BILL_TO_SHIPPING_KEY);\n\n    if (!isInitialized && localIsBillToShipping) {\n      setIsInitialized(true);\n      isBillToShipping.value = {\n        checked: localIsBillToShipping === 'true',\n        setByUser: false,\n      };\n      return;\n    }\n\n    if (!isInitialized && hasCartData) {\n      setIsInitialized(true);\n\n      const isSameShippingAndBilling = compareAddresses(\n        fields,\n        billingAddress,\n        shippingAddress\n      );\n\n      isBillToShipping.value = {\n        checked: cartData?.billingAddress\n          ? isSameShippingAndBilling\n          : isBillToShipping.value.checked,\n        setByUser: false,\n      };\n    }\n  }, [\n    billingAddress,\n    cartData?.billingAddress,\n    fields,\n    hasCartData,\n    isBillToShipping,\n    isInitialized,\n    shippingAddress,\n  ]);\n\n  return { isInitialized };\n};\n\nexport interface BillToShippingAddressProps\n  extends Omit<CheckboxProps, 'name' | 'label'> {}\n\nexport const BillToShippingAddress: Container<BillToShippingAddressProps> = ({\n  children,\n  ...props\n}) => {\n  const { data: cartData } = cartSignal.value;\n  const cartId = cartData?.id || '';\n  const isBillToShipping = isBillToShippingSignal.value.checked;\n\n  const { isInitialized } = useInitialState({\n    isBillToShipping: isBillToShippingSignal,\n  });\n\n  const onChangeHandler = (event: Event) => {\n    const checkbox = event.target as HTMLInputElement;\n    const isChecked = checkbox.checked;\n    const cartData = cartSignal.value.data;\n    const hasShippingAddress = Boolean(cartData?.shippingAddresses?.[0]);\n\n    isBillToShippingSignal.value = { checked: isChecked, setByUser: true };\n\n    localStorage.setItem(BILL_TO_SHIPPING_KEY, isChecked.toString());\n\n    if (isInitialized && isChecked && hasShippingAddress) {\n      const controller = new AbortController();\n\n      setBillingAddress({\n        signal: controller.signal,\n        cartId,\n        input: { same_as_shipping: true },\n      }).catch((error) => {\n        console.error(error);\n      });\n\n      return () => {\n        controller.abort();\n      };\n    }\n  };\n\n  return (\n    <BillToShippingAddressComponent\n      {...props}\n      checked={isBillToShipping}\n      isInitialized={isInitialized}\n      onChange={onChangeHandler}\n      disabled={cartSignal.value.pending}\n    />\n  );\n};\n"],"names":["BillToShippingAddress","className","isInitialized","checked","props","translations","useText","title","_jsx","BillToShippingAddressSkeleton","classes","children","Checkbox","name","label","Skeleton","SkeletonRow","variant","size","BILL_TO_SHIPPING_KEY","compareFields","first","second","field","firstValue","secondValue","undefined","JSON","stringify","compareAddresses","addressFormFields","every","fieldCode","code","useInitialState","isBillToShipping","setIsInitialized","useState","fields","useAddressFormFields","cartData","cartSignal","value","data","hasCartData","billingAddress","shippingAddress","shippingAddresses","useEffect","localIsBillToShipping","localStorage","getItem","setByUser","isSameShippingAndBilling","cartId","id","isBillToShippingSignal","onChangeHandler","event","checkbox","target","isChecked","hasShippingAddress","Boolean","setItem","toString","controller","AbortController","signal","input","same_as_shipping","catch","error","console","abort","BillToShippingAddressComponent","onChange","disabled","pending"],"mappings":"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"}